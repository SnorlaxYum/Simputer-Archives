<!doctype html><html lang=en><title>Running email service on my own server! - Terminal In A Simputer Archives</title><meta charset=utf-8><link rel=canonical href=https://archives.snorl.ax/drafts/running-email-service-on-my-own-server.html><link href=https://archives.snorl.ax/theme/css/all.css rel=stylesheet><link rel=dns-prefetch href=https://fonts.googleapis.com><link rel=dns-prefetch href=https://fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Luckiest+Guy|Rajdhani:600|Rajdhani:700&amp;display=swap"><link href=https://archives.snorl.ax/theme/images/icon.png rel=icon><link href=https://archives.snorl.ax/theme/images/icon-apple.png rel=apple-touch-icon-precomposed><link href=https://archives.snorl.ax/feeds/all.xml rel=alternate title="Simputer Archives RSS Feed" type=application/rss+xml><meta content=email name=tags><meta content=postfix name=tags><meta content=dovecot name=tags><meta content=saslauthd name=tags><meta content=Debian name=tags><meta content=imap name=tags><meta content=smtp name=tags><meta content=SendGrid name=tags><meta content=Amazon ses name=tags><meta content=dkim name=tags><meta content=spf name=tags><meta content=dmarc name=tags><meta content=mailutils name=tags><meta content=spamassassin name=tags><meta content="width=device-width" name=viewport><meta name=twitter:card content=summary><meta name=twitter:image content=https://archives.snorl.ax/theme/images/usual-twitter.png><meta name=twitter:site content=@Snorl_ax><meta name=twitter:title content="Running email service on my own server!"><meta name=twitter:description content="I've done it! Yes!"><div id=a><header id=c><div id=d><h1 id=e><a href=https://archives.snorl.ax/>Simputer Archives</a></h1></div></header><div id=f><nav id=h><ul><li><a href=https://archives.snorl.ax/>Home</a><li><a href=https://archives.snorl.ax/browser/>Browser</a><li id=i><a href=https://archives.snorl.ax/terminal/>Terminal</a><li><a href=https://archives.snorl.ax/tags/>Tags</a></ul></nav><nav id=r><a href=https://www.youtube.com/channel/UCnqOLMtPJaqa7e_6FhZ8-rw title=Youtube><svg id="youtube"/></a><a href=https://github.com/SnorlaxYum/ title=Github><svg id="github"/></a><a href=https://twitter.com/Snorl_ax title=Twitter><svg id="twitter"/></a><a href=https://archives.snorl.ax/feeds/all.xml title=RSS><svg id="rss"/></a><a href=mailto:sim@snorl.ax title=Email><svg id="mail"/></a></nav><aside id=j><form action=https://archives.snorl.ax/search.html onsubmit="return validateForm(this.elements['q'].value);"><input placeholder=Search... name=q id=tipue_search_input></form></aside></div></div><div id=b><main id=k><article id=m><header id=o><h2 id=p>Running email service on my own server!</h2></header><div id=n><p><strong>Env:</strong> Debian Stretch<sup id=fnref:1><a class=footnote-ref href=#fn:1 rel=footnote>1</a></sup><sup id=fnref:2><a class=footnote-ref href=#fn:2 rel=footnote>2</a></sup><p>If u want to follow the procedures below, be sure to replace informations like URL with ur own choice of configuration,<h2 id=toctable>Table Of Contents</h2><div class=toc><ul><li><a href=#update-hosts>Update Hosts</a><li><a href=#software-installation>Software Installation</a><li><a href=#configuring-postgresql>Configuring PostgreSQL</a><li><a href=#create-the-folder-and-user-for-mail>Create the folder and user for mail</a><li><a href=#configuring-postfix>Configuring Postfix</a><li><a href=#configuring-sasl2>Configuring SASL2</a><li><a href=#configuring-dovecot>Configuring Dovecot</a><li><a href=#configure-dns>Configure DNS</a><li><a href=#testing-imap>Testing Imap</a><li><a href=#smtp-method-1-smtp-relay>SMTP Method 1: SMTP Relay</a><li><a href=#smtp-method-2-postfix-sasl>SMTP Method 2: Postfix SASL</a><ul><li><a href=#configure-ssl>Configure SSL</a><li><a href=#postfix-to-dovecot-sasl-communication>Postfix to Dovecot SASL communication</a><li><a href=#enabling-sasl-authentication-in-the-postfix-smtp-server>Enabling SASL authentication in the Postfix SMTP server</a><li><a href=#postfix-smtp-server-policy-sasl-mechanism-properties>Postfix SMTP Server policy - SASL mechanism properties</a><li><a href=#mail-relay-authorization>Mail relay authorization</a><li><a href=#envelope-sender-address-authorization>Envelope sender address authorization</a><li><a href=#testing-sasl-authentication-in-the-postfix-smtp-server>Testing SASL authentication in the Postfix SMTP Server</a><li><a href=#enabling-sasl-authentication-in-the-postfix-smtplmtp-client>Enabling SASL authentication in the Postfix SMTP/LMTP client</a><li><a href=#open-the-submission-port>Open the submission port</a><li><a href=#configure-spf-and-dkim>Configure SPF and DKIM</a><ul><li><a href=#spf>SPF</a><li><a href=#dkim>DKIM</a></ul><li><a href=#set-up-domain-message-authentication-reporting-conformance-dmarc>Set up Domain Message Authentication, Reporting &amp; Conformance (DMARC)</a><li><a href=#optional-set-up-author-domain-signing-practices-adsp>Optional: Set up Author Domain Signing Practices (ADSP)</a><li><a href=#key-rotation>Key Rotation</a></ul><li><a href=#improve-the-password-encryption>Improve The Password Encryption</a><li><a href=#testing-smtp>Testing SMTP</a><li><a href=#block-some-brute-forcers>Block some Brute Forcers</a><li><a href=#hide-senders-ip-in-the-sent-mails-header>Hide sender's IP in the sent mail's header</a><li><a href=#integrate-spamassassin>Integrate Spamassassin</a><ul><li><a href=#solve-uribl_blocked>Solve URIBL_BLOCKED</a></ul></ul></div><h2 id=update-hosts><a class=toclink href=#update-hosts>Update Hosts</a></h2><p>Verify that the <code>/etc/hosts</code> file contains lines for the server's public IP address and is associated with the Fully Qualified Domain Name (FQDN). In the examples below, the public IP address of my VPS is <code>12.34.56.78</code> and <code>2aaa:bbb:dddd:eeee::1</code> and the FQDN is <code>mail.snorl.ax</code>.<div class=highlight><pre><span class=code-line><span></span>...</span>
<span class=code-line>12.34.56.78 mail.snorl.ax mail</span>
<span class=code-line>...</span>
<span class=code-line>2aaa:bbb:dddd:eeee::1</span>
</pre></div><p>Be sure to add an A Record for it. If assigned, AAAA of IPV6 is also needed.<div class=highlight><pre><span class=code-line><span></span>mail.snorl.ax   A 10 12.34.56.78</span>
<span class=code-line>mail.snorl.ax AAAA 10 2aaa:bbb:dddd:eeee::1</span>
</pre></div><p>Change the hostname to it as well<sup id=fnref:10><a class=footnote-ref href=#fn:10 rel=footnote>9</a></sup>.<div class=highlight><pre><span class=code-line><span></span>$ sudo hostname mail.snorl.ax</span>
</pre></div><p>Be sure to configure Reverse DNS for the IP to point to <code>mail.snorl.ax</code>.<h2 id=software-installation><a class=toclink href=#software-installation>Software Installation</a></h2><p>I'm using Debian Stretch on my Linode VPS, so I installed from stretch-backports<sup id=fnref:3><a class=footnote-ref href=#fn:3 rel=footnote>3</a></sup>. For backports to work, a line like the following one should be added to the <code>/etc/apt/sources.list</code>:<div class=highlight><pre><span class=code-line><span></span><span class=k>deb</span> <span class=s>http://ftp.debian.org/debian</span> <span class=kp>stretch-backports</span> <span class=kp>main</span></span>
</pre></div><p>The address could be my choice of source containing the backports, what I added before installation is:<div class=highlight><pre><span class=code-line><span></span><span class=k>deb</span> <span class=s>http://mirrors.linode.com/debian</span> <span class=kp>stretch-backports</span> <span class=kp>main</span></span>
</pre></div><p>Then I installed the packages using the command:<div class=highlight><pre><span class=code-line><span></span><span class=gp>$</span> sudo apt -t stretch-backports install postfix-pgsql sasl2-bin libsasl2-modules postgresql libpam-pgsql dovecot-pgsql dovecot-imapd dovecot-pop3d</span>
</pre></div><h2 id=configuring-postgresql><a class=toclink href=#configuring-postgresql>Configuring PostgreSQL</a></h2><p>Edit <code>/etc/postgresql/pg_hba.conf</code> to accept password authentication for localhost:<div class=highlight><pre><span class=code-line><span></span>host    all         all         127.0.0.1         255.255.255.255   password</span>
</pre></div><p>Create the database:<div class=highlight><pre><span class=code-line><span></span><span class=gp>$</span> sudo su postgres</span>
<span class=code-line><span class=gp>$</span> createdb mails</span>
<span class=code-line><span class=gp>$</span> psql mails</span>
</pre></div><p>Create tables:<div class=highlight><pre><span class=code-line><span></span><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=n>transport</span> <span class=p>(</span></span>
<span class=code-line>  <span class=k>domain</span> <span class=nb>VARCHAR</span><span class=p>(</span><span class=mf>128</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span></span>
<span class=code-line>  <span class=n>transport</span> <span class=nb>VARCHAR</span><span class=p>(</span><span class=mf>128</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span></span>
<span class=code-line>  <span class=k>PRIMARY</span> <span class=k>KEY</span> <span class=p>(</span><span class=k>domain</span><span class=p>)</span></span>
<span class=code-line><span class=p>);</span></span>
<span class=code-line><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=n>users</span> <span class=p>(</span></span>
<span class=code-line>  <span class=n>userid</span> <span class=nb>VARCHAR</span><span class=p>(</span><span class=mf>128</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span></span>
<span class=code-line>  <span class=k>password</span> <span class=nb>VARCHAR</span><span class=p>(</span><span class=mf>128</span><span class=p>),</span></span>
<span class=code-line>  <span class=n>realname</span> <span class=nb>VARCHAR</span><span class=p>(</span><span class=mf>128</span><span class=p>),</span></span>
<span class=code-line>  <span class=n>uid</span> <span class=nb>INTEGER</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span></span>
<span class=code-line>  <span class=n>gid</span> <span class=nb>INTEGER</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span></span>
<span class=code-line>  <span class=n>home</span> <span class=nb>VARCHAR</span><span class=p>(</span><span class=mf>128</span><span class=p>),</span></span>
<span class=code-line>  <span class=n>mail</span> <span class=nb>VARCHAR</span><span class=p>(</span><span class=mf>255</span><span class=p>),</span></span>
<span class=code-line>  <span class=k>PRIMARY</span> <span class=k>KEY</span> <span class=p>(</span><span class=n>userid</span><span class=p>)</span></span>
<span class=code-line><span class=p>);</span></span>
<span class=code-line><span class=k>CREATE</span> <span class=k>TABLE</span> <span class=n>virtual</span> <span class=p>(</span></span>
<span class=code-line>  <span class=n>address</span> <span class=nb>VARCHAR</span><span class=p>(</span><span class=mf>255</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span></span>
<span class=code-line>  <span class=n>userid</span> <span class=nb>VARCHAR</span><span class=p>(</span><span class=mf>255</span><span class=p>)</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>,</span></span>
<span class=code-line>  <span class=k>PRIMARY</span> <span class=k>KEY</span> <span class=p>(</span><span class=n>address</span><span class=p>)</span></span>
<span class=code-line><span class=p>);</span></span>
<span class=code-line><span class=k>create</span> <span class=k>view</span> <span class=n>postfix_mailboxes</span> <span class=k>as</span></span>
<span class=code-line>  <span class=k>select</span> <span class=n>userid</span><span class=p>,</span> <span class=n>home</span><span class=o>||</span><span class=s1>&#39;/&#39;</span> <span class=k>as</span> <span class=n>mailbox</span> <span class=k>from</span> <span class=n>users</span></span>
<span class=code-line>  <span class=k>union</span> <span class=k>all</span></span>
<span class=code-line>  <span class=k>select</span> <span class=k>domain</span> <span class=k>as</span> <span class=n>userid</span><span class=p>,</span> <span class=s1>&#39;dummy&#39;</span> <span class=k>as</span> <span class=n>mailbox</span> <span class=k>from</span> <span class=n>transport</span><span class=p>;</span></span>
<span class=code-line><span class=k>create</span> <span class=k>view</span> <span class=n>postfix_virtual</span> <span class=k>as</span></span>
<span class=code-line>  <span class=k>select</span> <span class=n>userid</span><span class=p>,</span> <span class=n>userid</span> <span class=k>as</span> <span class=n>address</span> <span class=k>from</span> <span class=n>users</span></span>
<span class=code-line>  <span class=k>union</span> <span class=k>all</span></span>
<span class=code-line>  <span class=k>select</span> <span class=n>userid</span><span class=p>,</span> <span class=n>address</span> <span class=k>from</span> <span class=n>virtual</span><span class=p>;</span></span>
</pre></div><p>Create separate users for read and write accesses. Postfix and Dovecot needs only read access. I may want to use the writer user for your own purposes.<div class=highlight><pre><span class=code-line><span></span><span class=k>CREATE</span> <span class=k>USER</span> <span class=n>mailreader</span> <span class=n>PASSWORD</span> <span class=s1>&#39;secret&#39;</span><span class=p>;</span></span>
<span class=code-line><span class=k>grant</span> <span class=k>select</span> <span class=k>on</span> <span class=n>transport</span><span class=p>,</span> <span class=n>users</span><span class=p>,</span> <span class=n>virtual</span><span class=p>,</span> <span class=n>postfix_mailboxes</span><span class=p>,</span> <span class=n>postfix_virtual</span> <span class=k>to</span> <span class=n>mailreader</span><span class=p>;</span></span>
<span class=code-line><span class=k>create</span> <span class=k>user</span> <span class=n>mailwriter</span> <span class=n>password</span> <span class=s1>&#39;secret&#39;</span><span class=p>;</span></span>
<span class=code-line><span class=k>grant</span> <span class=k>select</span><span class=p>,</span> <span class=k>insert</span><span class=p>,</span> <span class=k>update</span><span class=p>,</span> <span class=k>delete</span> <span class=k>on</span> <span class=n>transport</span><span class=p>,</span> <span class=n>users</span><span class=p>,</span> <span class=n>virtual</span><span class=p>,</span> <span class=n>postfix_mailboxes</span><span class=p>,</span> <span class=n>postfix_virtual</span> <span class=k>to</span> <span class=n>mailwriter</span><span class=p>;</span></span>
</pre></div><p>Add domain, user to the database. The examples below add the domain <code>snorl.ax</code> and a user with the mail address <code>kim@snorl.ax</code>:<div class=highlight><pre><span class=code-line><span></span><span class=k>insert</span> <span class=k>into</span> <span class=n>transport</span> <span class=p>(</span><span class=k>domain</span><span class=p>,</span> <span class=n>transport</span><span class=p>)</span> <span class=k>values</span> <span class=p>(</span><span class=s1>&#39;snorl.ax&#39;</span><span class=p>,</span> <span class=s1>&#39;virtual:&#39;</span><span class=p>);</span></span>
<span class=code-line><span class=k>insert</span> <span class=k>into</span> <span class=n>users</span> <span class=p>(</span><span class=n>userid</span><span class=p>,</span> <span class=n>uid</span><span class=p>,</span> <span class=n>gid</span><span class=p>,</span> <span class=n>home</span><span class=p>)</span> <span class=k>values</span> <span class=p>(</span><span class=s1>&#39;user@snorl.ax&#39;</span><span class=p>,</span> <span class=mi>5000</span><span class=p>,</span> <span class=mi>5000</span><span class=p>,</span> <span class=s1>&#39;snorl.ax/mails/user&#39;</span><span class=p>);</span></span>
<span class=code-line><span class=k>insert</span> <span class=k>into</span> <span class=n>users</span> <span class=p>(</span><span class=n>userid</span><span class=p>,</span> <span class=n>uid</span><span class=p>,</span> <span class=n>gid</span><span class=p>,</span> <span class=n>home</span><span class=p>)</span> <span class=k>values</span> <span class=p>(</span><span class=s1>&#39;user2@snorl.ax&#39;</span><span class=p>,</span> <span class=mi>5000</span><span class=p>,</span> <span class=mi>5000</span><span class=p>,</span> <span class=s1>&#39;snorl.ax/mails/user2&#39;</span><span class=p>);</span></span>
<span class=code-line><span class=k>insert</span> <span class=k>into</span> <span class=n>virtual</span> <span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=n>userid</span><span class=p>)</span> <span class=k>values</span> <span class=p>(</span><span class=s1>&#39;kim@snorl.ax&#39;</span><span class=p>,</span> <span class=s1>&#39;user@snorl.ax&#39;</span><span class=p>);</span></span>
</pre></div><p>The password for a user can be generated using <code>doveadm</code> utility<sup id=fnref:4><a class=footnote-ref href=#fn:4 rel=footnote>4</a></sup>:<div class=highlight><pre><span class=code-line><span></span><span class=gp>$</span> doveadm pw -s CRYPT</span>
</pre></div><p>It will prompt me to enter the password twice:<div class=highlight><pre><span class=code-line><span></span>Enter new password:</span>
<span class=code-line>Retype new password:</span>
</pre></div><p>Then it will print a encrypted string like the one below for me to write into the database:<div class=highlight><pre><span class=code-line><span></span>{CRYPT}1cElWVzS3.EVg</span>
</pre></div><p>To do something with the password, access the <code>psql</code> utility again:<div class=highlight><pre><span class=code-line><span></span><span class=gp>$</span> sudo su postgres</span>
<span class=code-line><span class=gp>$</span> psql mails</span>
</pre></div><p>To update an existing user with the password:<div class=highlight><pre><span class=code-line><span></span><span class=k>UPDATE</span> <span class=n>users</span> <span class=k>SET</span> <span class=n>password</span><span class=o>=</span><span class=s1>&#39;{CRYPT}1cElWVzS3.EVg&#39;</span> <span class=k>WHERE</span> <span class=n>userid</span><span class=o>=</span><span class=s1>&#39;user@snorl.ax&#39;</span><span class=p>;</span></span>
</pre></div><p>To set the password when creating the user:<div class=highlight><pre><span class=code-line><span></span><span class=k>insert</span> <span class=k>into</span> <span class=n>users</span> <span class=p>(</span><span class=n>userid</span><span class=p>,</span> <span class=n>password</span><span class=p>,</span> <span class=n>uid</span><span class=p>,</span> <span class=n>gid</span><span class=p>,</span> <span class=n>home</span><span class=p>)</span> <span class=k>values</span> <span class=p>(</span><span class=s1>&#39;user3@snorl.ax&#39;</span><span class=p>,</span> <span class=s1>&#39;{CRYPT}1cElWVzS3.EVg&#39;</span><span class=p>,</span> <span class=mi>5000</span><span class=p>,</span> <span class=mi>5000</span><span class=p>,</span> <span class=s1>&#39;snorl.ax/mails/user3&#39;</span><span class=p>);</span></span>
</pre></div><p>Self-check.<p>To check the existing user:<div class=highlight><pre><span class=code-line><span></span><span class=k>SELECT</span> <span class=o>*</span> <span class=k>FROM</span> <span class=n>users</span><span class=p>;</span></span>
</pre></div><p>A table like this will be shown:<div class=highlight><pre><span class=code-line><span></span>     userid     |       password       | realname | uid  | gid  |         home         | mail</span>
<span class=code-line>----------------+----------------------+----------+------+------+----------------------+------</span>
<span class=code-line> user1@snorl.ax | {CRYPT}xxxxxxxxxxxxx |          | 5000 | 5000 | snorl.ax/mails/user1 |</span>
<span class=code-line> user@snorl.ax  | {CRYPT}xxxxxxxxxxxxx |          | 5000 | 5000 | snorl.ax/mails/user  |</span>
</pre></div><p>To check the correspondence between username and mail address:<div class=highlight><pre><span class=code-line><span></span><span class=k>SELECT</span> <span class=o>*</span> <span class=k>FROM</span> <span class=n>virtual</span><span class=p>;</span></span>
</pre></div><p>A table similar to the following one will be shown:<div class=highlight><pre><span class=code-line><span></span>    address     |     userid     </span>
<span class=code-line>----------------+----------------</span>
<span class=code-line> kim@snorl.ax   | user@snorl.ax</span>
<span class=code-line> xxx@snorl.ax   | user2@snorl.ax</span>
<span class=code-line> xxxx@snorl.ax  | user1@snorl.ax</span>
</pre></div><h2 id=create-the-folder-and-user-for-mail><a class=toclink href=#create-the-folder-and-user-for-mail>Create the folder and user for mail</a></h2><p>Create <code>/var/mail/vhosts/</code> and the folder named my domain:<div class=highlight><pre><span class=code-line><span></span><span class=gp>$</span> sudo mkdir -p /var/mail/vhosts/snorl.ax</span>
</pre></div><p>Create the group and the user for it:<div class=highlight><pre><span class=code-line><span></span><span class=gp>$</span> sudo groupadd -g <span class=m>5000</span> vmail</span>
<span class=code-line><span class=gp>$</span> sudo useradd -g vmail -u <span class=m>5000</span> vmail -d /var/mail</span>
</pre></div><p>Change the owner of the <code>/var/mail/</code> folder and its contents to belong to <code>vmail</code>:<div class=highlight><pre><span class=code-line><span></span><span class=gp>$</span> sudo chown -R vmail:vmail /var/mail</span>
</pre></div><h2 id=configuring-postfix><a class=toclink href=#configuring-postfix>Configuring Postfix</a></h2><p>Edit <code>/etc/postfix/main.cf</code> to set the following values<sup id=fnref:12><a class=footnote-ref href=#fn:12 rel=footnote>10</a></sup>:<div class=highlight><pre><span class=code-line><span></span>transport_maps = pgsql:/etc/postfix/transport.cf</span>
<span class=code-line>virtual_uid_maps = pgsql:/etc/postfix/uids.cf</span>
<span class=code-line>virtual_gid_maps = pgsql:/etc/postfix/gids.cf</span>
<span class=code-line>virtual_mailbox_base = /var/mail/vhosts</span>
<span class=code-line>virtual_mailbox_maps = pgsql:/etc/postfix/mailboxes.cf</span>
<span class=code-line>virtual_maps = pgsql:/etc/postfix/virtual.cf</span>
<span class=code-line></span>
<span class=code-line>mydestination = localhost.$mydomain, $myhostname</span>
<span class=code-line>smtpd_relay_restrictions = permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination</span>
<span class=code-line>local_transport = virtual</span>
<span class=code-line>local_recipient_maps = $virtual_mailbox_maps</span>
<span class=code-line>smtpd_sasl_auth_enable = yes</span>
<span class=code-line>smtpd_sasl_security_options = noanonymous</span>
<span class=code-line>smtpd_sasl_local_domain = mail.snorl.ax</span>
<span class=code-line>smtp_sasl_auth_enable = no</span>
<span class=code-line>myorigin = $mydomain</span>
</pre></div><p>These defines mailbox domains and relevant settings such as sasl, mailbox location, rejecting unknown local recipients<sup id=fnref:19><a class=footnote-ref href=#fn:19 rel=footnote>17</a></sup>.<p>Edit <code>/etc/postfix/sasl/smtpd.conf</code> to include the following lines:<div class=highlight><pre><span class=code-line><span></span><span class=n>pwcheck_method</span><span class=o>:</span> <span class=n>saslauthd</span></span>
<span class=code-line><span class=n>saslauthd_path</span><span class=o>:</span> <span class=sr>/etc/</span><span class=n>mux</span></span>
</pre></div><p><code>/etc/postfix/transport.cf</code><div class=highlight><pre><span class=code-line><span></span>user=mailreader</span>
<span class=code-line>password=secret</span>
<span class=code-line>dbname=mails</span>
<span class=code-line>table=transport</span>
<span class=code-line>select_field=transport</span>
<span class=code-line>where_field=domain</span>
<span class=code-line>hosts=localhost</span>
</pre></div><p><code>/etc/postfix/uids.cf</code><div class=highlight><pre><span class=code-line><span></span>user=mailreader</span>
<span class=code-line>password=secret</span>
<span class=code-line>dbname=mails</span>
<span class=code-line>table=users</span>
<span class=code-line>select_field=uid</span>
<span class=code-line>where_field=userid</span>
<span class=code-line>hosts=localhost</span>
</pre></div><p><code>/etc/postfix/gids.cf</code><div class=highlight><pre><span class=code-line><span></span>user=mailreader</span>
<span class=code-line>password=secret</span>
<span class=code-line>dbname=mails</span>
<span class=code-line>table=users</span>
<span class=code-line>select_field=gid</span>
<span class=code-line>where_field=userid</span>
<span class=code-line>hosts=localhost</span>
</pre></div><p><code>/etc/postfix/mailboxes.cf</code><div class=highlight><pre><span class=code-line><span></span>user=mailreader</span>
<span class=code-line>password=secret</span>
<span class=code-line>dbname=mails</span>
<span class=code-line>table=postfix_mailboxes</span>
<span class=code-line>select_field=mailbox</span>
<span class=code-line>where_field=userid</span>
<span class=code-line>hosts=localhost</span>
</pre></div><p><code>/etc/postfix/virtual.cf</code><div class=highlight><pre><span class=code-line><span></span>user=mailreader</span>
<span class=code-line>password=secret</span>
<span class=code-line>dbname=mails</span>
<span class=code-line>table=postfix_virtual</span>
<span class=code-line>select_field=userid</span>
<span class=code-line>where_field=address</span>
<span class=code-line>hosts=localhost</span>
</pre></div><p>By default, these two lines are included in <code>/etc/postfix/main.cf</code>:<div class=highlight><pre><span class=code-line><span></span>alias_maps = hash:/etc/aliases</span>
<span class=code-line>alias_database = hash:/etc/aliases</span>
</pre></div><p>It's for the local delivery, meant to be sent to the users on the computer. Since I have the virtual domain and mailboxes, it will be more convenient to forward it to the mailbox. Put the lines in <code>/etc/aliases</code>:<div class=highlight><pre><span class=code-line><span></span># user: the mail address</span>
<span class=code-line>kim:    kim@snorl.ax</span>
<span class=code-line>root:   root@snorl.ax</span>
</pre></div><p>Then update:<div class=highlight><pre><span class=code-line><span></span>$ sudo newaliases</span>
</pre></div><p>In this case, local delivery will work. System messages to <code>kim</code> will be delivered to <code>kim@snorl.ax</code>.<h2 id=configuring-sasl2><a class=toclink href=#configuring-sasl2>Configuring SASL2</a></h2><p>Edit <code>/etc/default/saslauthd</code>:<div class=highlight><pre><span class=code-line><span></span>START=yes</span>
<span class=code-line>MECHANISMS=pam</span>
<span class=code-line>PARAMS=&quot;-r -m /var/spool/postfix/etc&quot;</span>
</pre></div><p><code>/etc/pam_pgsql.conf</code><div class=highlight><pre><span class=code-line><span></span>database = mails</span>
<span class=code-line>host = localhost</span>
<span class=code-line>user = mailreader</span>
<span class=code-line>password = secret</span>
<span class=code-line>table = users</span>
<span class=code-line>user_column = userid</span>
<span class=code-line>pwd_column = password</span>
<span class=code-line>#expired_column = acc_expired</span>
<span class=code-line>#newtok_column = acc_new_pwreq</span>
<span class=code-line>pw_type = crypt</span>
<span class=code-line>#debug</span>
</pre></div><p>Create <code>/etc/pam.d/smtp</code>:<div class=highlight><pre><span class=code-line><span></span>auth        required    pam_pgsql.so</span>
<span class=code-line>account     required    pam_pgsql.so</span>
<span class=code-line>password    required    pam_pgsql.so</span>
</pre></div><p>Put the following line to <code>/etc/postfix/sasl/smtpd.conf</code>:<div class=highlight><pre><span class=code-line><span></span><span class=n>mech_list</span><span class=o>:</span> <span class=n>login</span> <span class=n>plain</span></span>
</pre></div><h2 id=configuring-dovecot><a class=toclink href=#configuring-dovecot>Configuring Dovecot</a></h2><p>Put the following lines in the <code>/etc/dovecot/dovecot.conf</code>:<div class=highlight><pre><span class=code-line><span></span>mail_location = maildir:~/</span>
<span class=code-line>passdb {</span>
<span class=code-line>  args = /usr/local/etc/dovecot-sql.conf</span>
<span class=code-line>  driver = sql</span>
<span class=code-line>}</span>
<span class=code-line>userdb {</span>
<span class=code-line>  args = /usr/local/etc/dovecot-sql.conf</span>
<span class=code-line>  driver = sql</span>
<span class=code-line>}</span>
<span class=code-line>mail_privileged_group = vmail</span>
</pre></div><p><code>/usr/local/etc/dovecot-sql.conf</code>:<div class=highlight><pre><span class=code-line><span></span>driver = pgsql</span>
<span class=code-line>connect = host=localhost dbname=mails user=mailreader password=secret</span>
<span class=code-line>default_pass_scheme = CRYPT</span>
<span class=code-line>password_query = SELECT userid as user, password FROM users WHERE userid = &#39;%u&#39;</span>
<span class=code-line>user_query = SELECT &#39;/var/mail/vhosts/&#39;||home AS home, uid, gid FROM users WHERE userid = &#39;%u&#39;</span>
</pre></div><p>Ensure the following line is included in <code>/etc/dovecot/conf.d/10-auth.conf</code><sup id=fnref:5><a class=footnote-ref href=#fn:5 rel=footnote>5</a></sup>:<div class=highlight><pre><span class=code-line><span></span>disable_plaintext_auth = no</span>
</pre></div><p>I'll switch this back to <code>yes</code> or other options afterward. Plain text is for test.<h2 id=configure-dns><a class=toclink href=#configure-dns>Configure DNS</a></h2><p>When I'm ready to send and receive mails from my server, I should edit the domain's MX record so it points to the IP address of the server, similar to the examples below:<div class=highlight><pre><span class=code-line><span></span>mail.snorl.ax A 10 12.34.56.78</span>
<span class=code-line>mail.snorl.ax AAAA 10 2aaa:bbb:dddd:eeee::1</span>
<span class=code-line>snorl.ax MX 10 mail.snorl.ax</span>
</pre></div><h2 id=testing-imap><a class=toclink href=#testing-imap>Testing Imap</a></h2><p>Restart the relevant services before testing:<div class=highlight><pre><span class=code-line><span></span><span class=gp>$</span> sudo systemctl restart saslauthd postgresql postfix dovecot</span>
</pre></div><p>Install the Mailutils package:<div class=highlight><pre><span class=code-line><span></span><span class=gp>$</span> sudo apt-get install mailutils</span>
</pre></div><p>Log into an email account like gmail to send an email to <code>kim@snorl.ax</code>, then check if there's any message:<div class=highlight><pre><span class=code-line><span></span><span class=go>sudo mail -f /var/mail/vhosts/snorl.ax/mails/user</span></span>
</pre></div><p>Now test imap using an Email Client like ThunderBird:<ul><li><strong>Username:</strong> <code>user@snorl.ax</code>, the login name of <code>kim@snorl.ax</code>.<li><strong>Password:</strong> The one I just set, not the encrypted string. The one before being encrypted.<li><strong>Server name:</strong> <code>mail.snorl.ax</code>, or the IP address of the server.<li><strong>SSL:</strong> <code>None</code><li><strong>Port:</strong> 143</ul><h2 id=smtp-method-1-smtp-relay><a class=toclink href=#smtp-method-1-smtp-relay>SMTP Method 1: SMTP Relay</a></h2><p>An email sent from a server IP can easily go to Spam Folder if the IP reputation is bad or something is not configured correctly on the server, so it is safe to use an email delivery service.<br>I've used Amazon SES and Sendgrid. Both of them perform perfectly. Amazon SES charges $0.10 for every 1,000 emails you send. Sendgrid charges at least $14.95 monthly if u exceed 100 mails/day.<br>However u'll need request for a sending quota increase to get started with Amazon SES, while u can start with it as soon as u register on Sendgrid.<br>The documentations below r quite useful if u r using either of the email delivery services. They clarify how to configure the service and integrate it with Postfix and email client.<p>Some documentations useful for using <strong>Sendgrid</strong>:<ul><li><a href=https://sendgrid.com/docs/ui/account-and-settings/how-to-set-up-domain-authentication/ target=_blank>How to set up domain authentication</a><li><a href=https://sendgrid.com/docs/API_Reference/SMTP_API/integrating_with_the_smtp_api.html target=_blank>Integrating With the SMTP API</a><li><a href=https://sendgrid.com/docs/for-developers/sending-email/postfix/ target=_blank>Integrate SendGrid with Postfix</a></ul><p>Some documentations useful for using <strong>Amazon SES</strong>:<ul><li><a href=https://docs.aws.amazon.com/ses/latest/DeveloperGuide/quick-start.html target=_blank>Amazon SES Quick Start</a><li><a href=https://docs.aws.amazon.com/ses/latest/DeveloperGuide/postfix.html target=_blank>Integrating Amazon SES with Postfix</a><li><a href=https://docs.aws.amazon.com/ses/latest/DeveloperGuide/configure-email-client.html target=_blank>Configuring Email Clients to Send Through Amazon SES</a><li><a href=https://docs.aws.amazon.com/ses/latest/DeveloperGuide/mail-from.html target=_blank>Using a Custom MAIL FROM Domain with Amazon SES</a></ul><h2 id=smtp-method-2-postfix-sasl><a class=toclink href=#smtp-method-2-postfix-sasl>SMTP Method 2: Postfix SASL</a></h2><p>It is generally better to use my own server to send mails if I wanna have my own business and the IP reputation starts at least neutral.<p>To find out what SASL implementations are compiled into Postfix<sup id=fnref:6><a class=footnote-ref href=#fn:6 rel=footnote>6</a></sup>, use the following commands:<div class=highlight><pre><span class=code-line><span></span>$ postconf -a <span class=o>(</span>SASL support in the SMTP server<span class=o>)</span></span>
<span class=code-line>$ postconf -A <span class=o>(</span>SASL support in the SMTP+LMTP client<span class=o>)</span></span>
</pre></div><h3 id=configure-ssl><a class=toclink href=#configure-ssl>Configure SSL</a></h3><p>Generate a certificate for the domain (I use certbot) and configure postfix and dovecot to use it.<p>My ceritficate location:<br>Cert: <code>/etc/letsencrypt/live/snorl.ax/fullchain.pem</code><br>Key: <code>/etc/letsencrypt/live/snorl.ax/privkey.pem</code><p>Set the values in <code>/etc/postfix/main.cf</code>:<div class=highlight><pre><span class=code-line><span></span>smtpd_tls_cert_file=/etc/letsencrypt/live/snorl.ax/fullchain.pem</span>
<span class=code-line>smtpd_tls_key_file=/etc/letsencrypt/live/snorl.ax/privkey.pem</span>
</pre></div><p>Add the block into <code>/etc/dovecot/conf.d/10-ssl.conf</code><sup id=fnref:18><a class=footnote-ref href=#fn:18 rel=footnote>16</a></sup>:<div class=highlight><pre><span class=code-line><span></span>local_name mail.snorl.ax {</span>
<span class=code-line>  ssl_cert = &lt;/etc/letsencrypt/live/snorl.ax/fullchain.pem</span>
<span class=code-line>  ssl_key = &lt;/etc/letsencrypt/live/snorl.ax/privkey.pem</span>
<span class=code-line>}</span>
</pre></div><p>Restart them to see the effect:<div class=highlight><pre><span class=code-line><span></span>$ sudo systemctl restart dovecot postfix</span>
</pre></div><h3 id=postfix-to-dovecot-sasl-communication><a class=toclink href=#postfix-to-dovecot-sasl-communication>Postfix to Dovecot SASL communication</a></h3><p>It saves hassle to configure Postfix to Dovecot SASL communication.<p>Relevant block in <code>/etc/dovecot/conf.d/10-master.conf</code> (to place the Dovecot SASL socket in the path and make it writable and readable by user and group <code>postfix</code> only):<div class=highlight><pre><span class=code-line><span></span>service auth {</span>
<span class=code-line>  ...</span>
<span class=code-line>  unix_listener /var/spool/postfix/private/auth {</span>
<span class=code-line>    mode = 0660</span>
<span class=code-line>    # Assuming the default Postfix user and group</span>
<span class=code-line>    user = postfix</span>
<span class=code-line>    group = postfix        </span>
<span class=code-line>  }</span>
<span class=code-line>  ...</span>
<span class=code-line>}</span>
</pre></div><p>Specify the following value in <code>/etc/dovecot/conf.d/10-auth.conf</code>:<div class=highlight><pre><span class=code-line><span></span>auth_mechanisms = plain login</span>
</pre></div><h3 id=enabling-sasl-authentication-in-the-postfix-smtp-server><a class=toclink href=#enabling-sasl-authentication-in-the-postfix-smtp-server>Enabling SASL authentication in the Postfix SMTP server</a></h3><p>Specify the following value in <code>/etc/postfix/main.cf</code>:<div class=highlight><pre><span class=code-line><span></span>smtpd_sasl_type = dovecot</span>
<span class=code-line>smtpd_sasl_path = private/auth</span>
<span class=code-line>smtpd_sasl_auth_enable = yes</span>
<span class=code-line>broken_sasl_auth_clients = yes</span>
</pre></div><h3 id=postfix-smtp-server-policy-sasl-mechanism-properties><a class=toclink href=#postfix-smtp-server-policy-sasl-mechanism-properties>Postfix SMTP Server policy - SASL mechanism properties</a></h3><p>Set the desired values in <code>/etc/postfix/main.cf</code>.<p>Deny anonymous authentication:<div class=highlight><pre><span class=code-line><span></span>smtpd_sasl_security_options = noanonymous</span>
<span class=code-line>smtpd_sasl_tls_security_options = $smtpd_sasl_security_options</span>
</pre></div><p>A more sophisticated policy allows plaintext mechanisms, but only over a TLS-encrypted connection:<div class=highlight><pre><span class=code-line><span></span>smtpd_sasl_security_options = noanonymous, noplaintext</span>
<span class=code-line>smtpd_sasl_tls_security_options = noanonymous</span>
</pre></div><p>To offer SASL authentication only after a TLS-encrypted session has been established specify this:<div class=highlight><pre><span class=code-line><span></span>smtpd_tls_auth_only = yes</span>
</pre></div><h3 id=mail-relay-authorization><a class=toclink href=#mail-relay-authorization>Mail relay authorization</a></h3><p>Set the desired values in <code>/etc/postfix/main.cf</code>. With <code>permit_sasl_authenticated</code> the Postfix SMTP server can allow SASL-authenticated SMTP clients to send mail to remote destinations. Examples:<div class=highlight><pre><span class=code-line>smtpd_relay_restrictions =</span>
<span class=code-line>    permit_mynetworks</span>
<span class=code-line>    <b>permit_sasl_authenticated</b></span>
<span class=code-line>    reject_unauth_destination</pre>...other rules...</pre></div><h3 id=envelope-sender-address-authorization><a class=toclink href=#envelope-sender-address-authorization>Envelope sender address authorization</a></h3><p>In <code>/etc/postfix/main.cf</code>, configure <code>smtpd_sender_login_maps</code> and add <code>reject_sender_login_mismatch</code> before <code>permit_sasl_authenticated</code> in <code>smtpd_recipient_restrictions</code>:<div class=highlight><pre><span class=code-line><b>smtpd_sender_login_maps = hash:/etc/postfix/controlled_envelope_senders</b></span>
<span class=code-line>    smtpd_relay_restrictions =</span>
<span class=code-line>    ...</span>
<span class=code-line>    <b>reject_sender_login_mismatch</b></span>
<span class=code-line>    permit_sasl_authenticated</span>
<span class=code-line>    ...</pre></div><p>The table in <code>/etc/postfix/controlled_envelope_senders</code> should be configured like this:<div class=highlight><pre><span class=code-line><span></span># envelope sender           owners (SASL login names)</span>
<span class=code-line>kim@snorl.ax                user@snorl.ax</span>
<span class=code-line>som@snorl.ax                user1@snorl.ax</span>
</pre></div><p>On the left is the email address, on the right is the login name.<p>Generate the database:<div class=highlight><pre><span class=code-line><span></span>$ sudo postmap /etc/postfix/controlled_envelope_senders</span>
</pre></div><p>Now, the Postfix SMTP server knows who the sender is. Given a table of envelope sender addresses and SASL login names, the Postfix SMTP server can decide if the SASL authenticated client is allowed to use a particular envelope sender address.<h3 id=testing-sasl-authentication-in-the-postfix-smtp-server><a class=toclink href=#testing-sasl-authentication-in-the-postfix-smtp-server>Testing SASL authentication in the Postfix SMTP Server</a></h3><p>To test the server side, connect (for example, with <code>telnet</code>) to the Postfix SMTP server port and you should be able to have a conversation as shown below. Information sent by the client is shown in <code>bold</code> font.<div class=highlight><pre><span class=code-line>$ <b>telnet server.example.com 25</b></span>
<span class=code-line>...</span>
<span class=code-line>220 server.example.com ESMTP Postfix</span>
<span class=code-line><b>EHLO client.example.com</b></span>
<span class=code-line>250-server.example.com</span>
<span class=code-line>250-PIPELINING</span>
<span class=code-line>250-SIZE 10240000</span>
<span class=code-line>250-ETRN</span>
<span class=code-line>250-AUTH DIGEST-MD5 PLAIN CRAM-MD5</span>
<span class=code-line>250 8BITMIME</span>
<span class=code-line>AUTH PLAIN AHRlc3QAdGVzdHBhc3M=</span>
<span class=code-line>235 Authentication successful</pre></div><p>To test this over a connection that is encrypted with TLS, use openssl s_client instead of telnet:<div class=highlight><pre><span class=code-line>$ <b>openssl s_client -connect server.example.com:25 -starttls smtp</b></span>
<span class=code-line>...</span>
<span class=code-line>220 server.example.com ESMTP Postfix</span>
<span class=code-line><b>EHLO client.example.com</b></span>
<span class=code-line>...see above example for more...</pre></div><p>Use a recent version of <code>bash</code> shell and replace the <code>AHRlc3QAdGVzdHBhc3M=</code> above with the output of this command:<div class=highlight><pre><span class=code-line><span></span>echo -ne &#39;\000username\000password&#39; | openssl base64</span>
</pre></div><h3 id=enabling-sasl-authentication-in-the-postfix-smtplmtp-client><a class=toclink href=#enabling-sasl-authentication-in-the-postfix-smtplmtp-client>Enabling SASL authentication in the Postfix SMTP/LMTP client</a></h3><p>Set the values in <code>/etc/postfix/main.cf</code>:<div class=highlight><pre><span class=code-line><span></span>smtp_sasl_auth_enable = yes</span>
<span class=code-line>smtp_tls_security_level = encrypt</span>
<span class=code-line>smtp_sasl_password_maps = pgsql:/etc/postfix/password.cf</span>
</pre></div><p>In <code>/etc/postfix/password.cf</code>:<div class=highlight><pre><span class=code-line><span></span>user=mailreader</span>
<span class=code-line>password=secret</span>
<span class=code-line>dbname=mails</span>
<span class=code-line>table=users</span>
<span class=code-line>select_field=password</span>
<span class=code-line>where_field=userid</span>
<span class=code-line>hosts=localhost</span>
</pre></div><p>Restart postfix to see the effect:<div class=highlight><pre><span class=code-line><span></span>$ sudo systemctl restart postfix</span>
</pre></div><h3 id=open-the-submission-port><a class=toclink href=#open-the-submission-port>Open the submission port</a></h3><p>The submission port is recommended to be used for smtp.<p>Uncomment the following line in <code>/etc/postfix/master.cf</code>:<div class=highlight><pre><span class=code-line><span></span>submission inet n       -       y       -       -       smtpd</span>
</pre></div><p>Restart postfix to see the effect:<div class=highlight><pre><span class=code-line><span></span>$ sudo systemctl restart postfix</span>
</pre></div><h3 id=configure-spf-and-dkim><a class=toclink href=#configure-spf-and-dkim>Configure SPF and DKIM</a></h3><p>Install DKIM, SPF and Postfix-pcre<sup id=fnref:7><a class=footnote-ref href=#fn:7 rel=footnote>7</a></sup>,<div class=highlight><pre><span class=code-line><span></span>$ sudo apt-get install opendkim opendkim-tools postfix-policyd-spf-python postfix-pcre</span>
</pre></div><h4 id=spf><a class=toclink href=#spf>SPF</a></h4><p>Add spf as a TXT Record to DNS:<div class=highlight><pre><span class=code-line><span></span>snorl.ax TXT &quot;v=spf1 mx -all&quot;</span>
</pre></div><p>Add the following entry to <code>/etc/postfix/master.cf</code>:<div class=highlight><pre><span class=code-line><span></span>policyd-spf  unix  -       n       n       -       0       spawn</span>
<span class=code-line>    user=policyd-spf argv=/usr/bin/policyd-spf</span>
</pre></div><p>Configure the following value in <code>/etc/postfix/main.cf</code>:<div class=highlight><pre><span class=code-line><span></span>policyd-spf_time_limit = 3600</span>
</pre></div><p>In <code>/etc/postfix/main.cf</code>, edit the <code>smtpd_relay_restrictions</code> entry to add a <code>check_policy_service</code> entry:<div class=highlight><pre><span class=code-line><span></span>smtpd_relay_restrictions =</span>
<span class=code-line>    ...</span>
<span class=code-line>    reject_unauth_destination,</span>
<span class=code-line>    check_policy_service unix:private/policyd-spf,</span>
<span class=code-line>    ...</span>
</pre></div><p>Make sure to add the <code>check_policy_service</code> entry after the <code>reject_unauth_destination</code> entry to avoid having your system become an open relay. If <code>reject_unauth_destination</code> is the last item in your restrictions list, add the comma after it and omit the comma at the end of the <code>check_policy_service</code> item above.<p>Restart Postfix.<div class=highlight><pre><span class=code-line><span></span>$ sudo systemctl restart postfix</span>
</pre></div><p>Check the operation of the policy agent by looking at raw headers on incoming email messages for the SPF results header. The header the policy agent adds to messages should look something like this:<div class=highlight><pre><span class=code-line><span></span><span class=nt>Received-SPF</span><span class=o>:</span> <span class=nt>Pass</span> <span class=o>(</span><span class=nt>sender</span> <span class=nt>SPF</span> <span class=nt>authorized</span><span class=o>)</span> <span class=nt>identity</span><span class=o>=</span><span class=nt>mailfrom</span><span class=o>;</span> <span class=nt>client-ip</span><span class=o>=</span><span class=nt>127</span><span class=p>.</span><span class=nc>0</span><span class=p>.</span><span class=nc>0</span><span class=p>.</span><span class=nc>1</span><span class=o>;</span> <span class=nt>helo</span><span class=o>=</span><span class=nt>mail</span><span class=p>.</span><span class=nc>snorl</span><span class=p>.</span><span class=nc>ax</span><span class=o>;</span> <span class=nt>envelope-from</span><span class=o>=</span><span class=nt>text</span><span class=p>@</span><span class=k>snorl</span><span class=p>.</span><span class=nc>ax</span><span class=p>;</span> <span class=nt>receiver</span><span class=o>=</span><span class=nt>tknarr</span><span class=p>@</span><span class=k>silverglass</span><span class=p>.</span><span class=nc>org</span></span>
</pre></div><h4 id=dkim><a class=toclink href=#dkim>DKIM</a></h4><p>Edit <code>/etc/opendkim.conf</code> and uncomment or edit certain lines:<div class=highlight><pre><span class=code-line><span></span># This is a basic configuration that can easily be adapted to suit a standard</span>
<span class=code-line># installation. For more advanced options, see opendkim.conf(5) and/or</span>
<span class=code-line># /usr/share/doc/opendkim/examples/opendkim.conf.sample.</span>
<span class=code-line></span>
<span class=code-line># Log to syslog</span>
<span class=code-line>Syslog          yes</span>
<span class=code-line># Required to use local socket with MTAs that access the socket as a non-</span>
<span class=code-line># privileged user (e.g. Postfix)</span>
<span class=code-line>UMask           002</span>
<span class=code-line># OpenDKIM user</span>
<span class=code-line># Remember to add user postfix to group opendkim</span>
<span class=code-line>UserID          opendkim</span>
<span class=code-line></span>
<span class=code-line># Map domains in From addresses to keys used to sign messages</span>
<span class=code-line>KeyTable        /etc/opendkim/key.table</span>
<span class=code-line>SigningTable        refile:/etc/opendkim/signing.table</span>
<span class=code-line></span>
<span class=code-line># Hosts to ignore when verifying signatures</span>
<span class=code-line>ExternalIgnoreList  /etc/opendkim/trusted.hosts</span>
<span class=code-line>InternalHosts       /etc/opendkim/trusted.hosts</span>
<span class=code-line></span>
<span class=code-line># Commonly-used options; the commented-out versions show the defaults.</span>
<span class=code-line>Canonicalization    relaxed/simple</span>
<span class=code-line>Mode            sv</span>
<span class=code-line>SubDomains      no</span>
<span class=code-line>#ADSPAction     continue</span>
<span class=code-line>AutoRestart     yes</span>
<span class=code-line>AutoRestartRate     10/1M</span>
<span class=code-line>Background      yes</span>
<span class=code-line>DNSTimeout      5</span>
<span class=code-line>SignatureAlgorithm  rsa-sha256</span>
<span class=code-line></span>
<span class=code-line># Always oversign From (sign using actual From and a null From to prevent</span>
<span class=code-line># malicious signatures header fields (From and/or others) between the signer</span>
<span class=code-line># and the verifier.  From is oversigned by default in the Debian package</span>
<span class=code-line># because it is often the identity key used by reputation systems and thus</span>
<span class=code-line># somewhat security sensitive.</span>
<span class=code-line>OversignHeaders     From</span>
<span class=code-line></span>
<span class=code-line></span>
<span class=code-line># Socket smtp://localhost</span>
<span class=code-line>#</span>
<span class=code-line># ##  Socket socketspec</span>
<span class=code-line># ##</span>
<span class=code-line># ##  Names the socket where this filter should listen for milter connections</span>
<span class=code-line># ##  from the MTA.  Required.  Should be in one of these forms:</span>
<span class=code-line># ##</span>
<span class=code-line># ##  inet:port@address           to listen on a specific interface</span>
<span class=code-line># ##  inet:port                   to listen on all interfaces</span>
<span class=code-line># ##  local:/path/to/socket       to listen on a UNIX domain socket</span>
<span class=code-line>#</span>
<span class=code-line>Socket                  local:/var/spool/postfix/opendkim/opendkim.sock</span>
<span class=code-line></span>
<span class=code-line>##  PidFile filename</span>
<span class=code-line>###      default (none)</span>
<span class=code-line>###</span>
<span class=code-line>###  Name of the file where the filter should write its pid before beginning</span>
<span class=code-line>###  normal operations.</span>
<span class=code-line>#</span>
<span class=code-line>PidFile               /var/run/opendkim/opendkim.pid</span>
</pre></div><p>Ensure the permission is correctly set:<div class=highlight><pre><span class=code-line><span></span>$ sudo chmod <span class=nv>u</span><span class=o>=</span>rw,go<span class=o>=</span>r /etc/opendkim.conf</span>
</pre></div><p>Create directory for the socket:<div class=highlight><pre><span class=code-line><span></span>$ sudo mkdir /var/spool/postfix/opendkim</span>
<span class=code-line>$ chown opendkim:postfix /var/spool/postfix/opendkim</span>
</pre></div><p>Create directory for OpenDKIM's data files:<div class=highlight><pre><span class=code-line><span></span>$ sudo mkdir -p /etc/opendkim/keys</span>
<span class=code-line>$ sudo chown -R opendkim:opendkim /etc/opendkim</span>
<span class=code-line>$ sudo chmod go-rw /etc/opendkim/keys</span>
</pre></div><p>Create <code>/etc/opendkim/signing.table</code><div class=highlight><pre><span class=code-line><span></span>*@snorl.ax   sim</span>
</pre></div><p>Create <code>/etc/opendkim/key.table</code><div class=highlight><pre><span class=code-line><span></span>sim     snorl.ax:YYYYMM:/etc/opendkim/keys/example.private</span>
</pre></div><p>replace the <code>YYYYMM</code> with the current 4-digit year and 2-digit month (this is referred to as the selector)<p>Create <code>/etc/opendkim/trusted.hosts</code><div class=highlight><pre><span class=code-line><span></span>127.0.0.1</span>
<span class=code-line>::1</span>
<span class=code-line>localhost</span>
<span class=code-line>sim</span>
<span class=code-line>sim.snorl.ax</span>
<span class=code-line>snorl.ax</span>
</pre></div><p>Set the permission:<div class=highlight><pre><span class=code-line><span></span>$ sudo chown -R opendkim:opendkim /etc/opendkim</span>
<span class=code-line>$ sudo chmod -R go-rwx /etc/opendkim/keys</span>
</pre></div><p>Generate the key:<div class=highlight><pre><span class=code-line><span></span>$ sudo opendkim-genkey -b <span class=m>2048</span> -h rsa-sha256 -r -s YYYYMM -d example.com -v</span>
</pre></div><p>Move it to the set path:<div class=highlight><pre><span class=code-line><span></span>$ sudo mv YYYYMM.private /etc/opendkim/keys/example.private</span>
<span class=code-line>$ sudo mv YYYYMM.txt /etc/opendkim/keys/example.txt</span>
</pre></div><p>Make sure all the files in the dir have correct permissions:<div class=highlight><pre><span class=code-line><span></span>$ <span class=nb>cd</span> /etc</span>
<span class=code-line>$ sudo chown -R opendkim:opendkim /etc/opendkim</span>
<span class=code-line>$ sudo chmod -R go-rw /etc/opendkim/keys</span>
</pre></div><p>Restart to see if there's any error:<div class=highlight><pre><span class=code-line><span></span>$ sudo systemctl restart opendkim</span>
</pre></div><p>Check it if there's any error:<div class=highlight><pre><span class=code-line><span></span>$ sudo systemctl status -l opendkim</span>
</pre></div><p>For example, in <code>/etc/opendkim/keys/example.txt</code>:<div class=highlight><pre><span class=code-line><span></span>201510._domainkey  IN  TXT ( &quot;**v=DKIM1; h=rsa-sha256; k=rsa; s=email; &quot;</span>
<span class=code-line>    &quot;p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAu5oIUrFDWZK7F4thFxpZa2or6jBEX3cSL6b2TJdPkO5iNn9vHNXhNX31nOefN8FksX94YbLJ8NHcFPbaZTW8R2HthYxRaCyqodxlLHibg8aHdfa+bxKeiI/xABRuAM0WG0JEDSyakMFqIO40ghj/h7DUc/4OXNdeQhrKDTlgf2bd+FjpJ3bNAFcMYa3Oeju33b2Tp+PdtqIwXR&quot;</span>
<span class=code-line>    &quot;ZksfuXh7m30kuyavp3Uaso145DRBaJZA55lNxmHWMgMjO+YjNeuR6j4oQqyGwzPaVcSdOG8Js2mXt+J3Hr+nNmJGxZUUW4Uw5ws08wT9opRgSpn+ThX2d1AgQePpGrWOamC3PdcwIDAQAB**&quot; )  ; ----- DKIM key 201510 for example.com</span>
</pre></div><p>The value inside the parentheses is needed. Select and copy the entire region from (but not including) the double-quote before v=DKIM1 on up to (but not including) the final double-quote before the closing parentheses. Then edit out the double-quotes within the copied text and the whitespace between them. Also change h=rsa-sha256 to h=sha256. From the above file the result would be:<div class=highlight><pre><span class=code-line><span></span>v=DKIM1; h=sha256; k=rsa; s=email; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAu5oIUrFDWZK7F4thFxpZa2or6jBEX3cSL6b2TJdPkO5iNn9vHNXhNX31nOefN8FksX94YbLJ8NHcFPbaZTW8R2HthYxRaCyqodxlLHibg8aHdfa+bxKeiI/xABRuAM0WG0JEDSyakMFqIO40ghj/h7DUc/4OXNdeQhrKDTlgf2bd+FjpJ3bNAFcMYa3Oeju33b2Tp+PdtqIwXRZksfuXh7m30kuyavp3Uaso145DRBaJZA55lNxmHWMgMjO+YjNeuR6j4oQqyGwzPaVcSdOG8Js2mXt+J3Hr+nNmJGxZUUW4Uw5ws08wT9opRgSpn+ThX2d1AgQePpGrWOamC3PdcwIDAQAB</span>
</pre></div><p>Paste that into the value for the TXT record in DNS:<div class=highlight><pre><span class=code-line><span></span>201510._domainkey.snorl.ax   TXT  The_Value</span>
</pre></div><p>Test the key:<div class=highlight><pre><span class=code-line><span></span>$ opendkim-testkey -d snorl.ax -s YYYYMM</span>
</pre></div><p>To hook it into the postfix, edit <code>/etc/postfix/main.cf</code>:<div class=highlight><pre><span class=code-line><span></span># OpenDKIM</span>
<span class=code-line>milter_default_action = accept</span>
<span class=code-line># Postfix ≥ 2.6 milter_protocol = 6, Postfix ≤ 2.5 milter_protocol = 2</span>
<span class=code-line>milter_protocol = 6</span>
<span class=code-line>smtpd_milters = local:opendkim/opendkim.sock</span>
<span class=code-line>non_smtpd_milters = $smtpd_milters</span>
</pre></div><p>Add user postfix to group opendkim:<div class=highlight><pre><span class=code-line><span></span>$ sudo usermod -a -G opendkim postfix</span>
</pre></div><p>Restart them.<div class=highlight><pre><span class=code-line><span></span>$ sudo systemctl restart opendkim postfix</span>
</pre></div><p>Verify if everything’s working by sending a test e-mail to <code>check-auth@verifier.port25.com</code> using an email client configured to submit mail to the submission port on the mail server.<h3 id=set-up-domain-message-authentication-reporting-conformance-dmarc><a class=toclink href=#set-up-domain-message-authentication-reporting-conformance-dmarc>Set up Domain Message Authentication, Reporting &amp; Conformance (DMARC)</a></h3><p>Add the following TXT record in DNS:<div class=highlight><pre><span class=code-line><span></span>_dmarc.snorl.ax TXT v=DMARC1;p=quarantine;sp=quarantine;adkim=r;aspf=r;fo=1;rf=afrf;rua=mailto:admin@snorl.ax</span>
</pre></div><p>This requests mail servers to quarantine (do not discard, but separate from regular messages) any email that fails either SPF or DKIM checks. The report will be <code>admin@snorl.ax</code>.<h3 id=optional-set-up-author-domain-signing-practices-adsp><a class=toclink href=#optional-set-up-author-domain-signing-practices-adsp>Optional: Set up Author Domain Signing Practices (ADSP)</a></h3><p>Add an ADSP policy to the domain saying that all emails from the domain should be DKIM-signed:<div class=highlight><pre><span class=code-line><span></span>_adsp._domainkey.snorl.ax   TXT dkim=all</span>
</pre></div><h3 id=key-rotation><a class=toclink href=#key-rotation>Key Rotation</a></h3><p>The reason the YYYYMM format is used for the selector is that best practice calls for changing the DKIM signing keys every so often (monthly is recommended, and no longer than every 6 months).<p>Generate it in my home dir:<div class=highlight><pre><span class=code-line><span></span>$ opendkim-genkey -b <span class=m>2048</span> -h rsa-sha256 -r -s YYYYMM -d snorl.ax -v</span>
</pre></div><p>Set the DNS the way it is done above, test it:<div class=highlight><pre><span class=code-line><span></span>$ opendkim-testkey -d example.com -s YYYYMM -k example.private</span>
</pre></div><p>Stop opendkim for a moment:<div class=highlight><pre><span class=code-line><span></span>$ sudo systemctl stop opendkim</span>
</pre></div><p>Copy it to the path:<div class=highlight><pre><span class=code-line><span></span>cp *.private /etc/opendkim/keys/</span>
<span class=code-line>chown opendkim:opendkim /etc/opendkim/keys/*</span>
<span class=code-line>chmod go-rw /etc/opendkim/keys/*</span>
</pre></div><p>Edit <code>/etc/opendkim/key.table</code> and change the old YYYYMM values to the new selector, reflecting the current year and month. Save the file. Then restart postfix and opendkim to see the effect. Be sure to delete the old <code>YYYYMM._domainkey</code> TXT record.<h2 id=improve-the-password-encryption><a class=toclink href=#improve-the-password-encryption>Improve The Password Encryption</a></h2><p><code>CRYPT</code> is weak, only uses the first 8 characters of the password, the rest are ignored.<br><code>CRAM-MD5</code> protects the password in transit against eaves droppers and somewhat gets good support in clients.<br>So it's the default method doveadm uses<sup id=fnref:13><a class=footnote-ref href=#fn:13 rel=footnote>11</a></sup><sup id=fnref:14><a class=footnote-ref href=#fn:14 rel=footnote>12</a></sup>. To generate a CRAM-MD5 for a password:<div class=highlight><pre><span class=code-line><span></span>$ doveadm pw</span>
</pre></div><p>Enter the password twice:<div class=highlight><pre><span class=code-line><span></span>Enter new password:</span>
<span class=code-line>Retype new password:</span>
</pre></div><p>Then a hash like this will be generated and printed:<div class=highlight><pre><span class=code-line><span></span>{CRAM-MD5}26b633ec8bf9dd526293c5897400bddeef9299fad</span>
</pre></div><p>To do something with the password, access the <code>psql</code> utility again:<div class=highlight><pre><span class=code-line><span></span>$ sudo su postgres</span>
<span class=code-line>$ psql mails</span>
</pre></div><p>To check the existing user:<div class=highlight><pre><span class=code-line><span></span>SELECT * FROM users;</span>
</pre></div><p>A table like this will be shown:<div class=highlight><pre><span class=code-line><span></span>     userid     |       password       | realname | uid  | gid  |         home         | mail</span>
<span class=code-line>----------------+----------------------------------------------------------------------------+----------+------+------+----------------------+------</span>
<span class=code-line> user1@snorl.ax | {CRYPT}xxxxxxxxxxxxx |          | 5000 | 5000 | snorl.ax/mails/user1 |</span>
<span class=code-line> user@snorl.ax  | {CRYPT}xxxxxxxxxxxxx |          | 5000 | 5000 | snorl.ax/mails/user  |</span>
</pre></div><p>To check the correspondence between username and mail address:<div class=highlight><pre><span class=code-line><span></span>SELECT * FROM virtual;</span>
</pre></div><p>A table similar to the following one will be shown:<div class=highlight><pre><span class=code-line><span></span>    address     |     userid     </span>
<span class=code-line>----------------+----------------</span>
<span class=code-line> xxxx@snorl.ax  | user@snorl.ax</span>
<span class=code-line> xxx@snorl.ax   | user2@snorl.ax</span>
<span class=code-line> xxxx@snorl.ax  | user@snorl.ax</span>
</pre></div><p>To update an existing user with the password:<div class=highlight><pre><span class=code-line><span></span>UPDATE users SET password=&#39;{CRAM-MD5}26b633ec8bf9dd526293c5897400bddeef9299fad&#39; WHERE userid=&#39;user@snorl.ax&#39;;</span>
</pre></div><p>In <code>/etc/dovecot/conf.d/10-auth.conf</code>, disable plaintext login and add cram-md5 to the mechanisms:<div class=highlight><pre><span class=code-line>...</span>
<span class=code-line><b>disable_plaintext_auth = yes</b></span>
<span class=code-line>...</span>
<span class=code-line>auth_mechanisms = plain login <b>cram-md5</b></pre></div><p>In <code>/etc/postfix/sasl/smtpd.conf</code>, set the corresponding option to:<div class=highlight><pre><span class=code-line>mech_list: login plain <b>cram-md5</b></pre></div><p>In <code>/etc/pam_pgsql.conf</code>, set it to cram-md5:<div class=highlight><pre><span class=code-line>...</span>
<span class=code-line>pw_type = <b>cram-md5</b></span>
<span class=code-line>...</pre></div><p>In <code>/usr/local/etc/dovecot-sql.conf</code>, set it to cram-md5:<div class=highlight><pre><span class=code-line>...</span>
<span class=code-line>default_pass_scheme = <b>CRAM-MD5</b></span>
<span class=code-line>...</pre></div><p>Then test logging in with <code>encrypted password</code> over SSL in imap and STARTTLS in smtp.<h2 id=testing-smtp><a class=toclink href=#testing-smtp>Testing SMTP</a></h2><p>Test sending mail outside of my mail server, like a Gmail account.<div class=highlight><pre><span class=code-line><span></span>echo &quot;Email body text&quot; | sudo mail -s &quot;Email subject line&quot; recipient@gmail.com -aFrom:kim@snorl.ax</span>
</pre></div><p>Sometimes if I test sending while having the <code>@snorl.ax</code> omitted, like this:<div class=highlight><pre><span class=code-line><span></span>echo &quot;Email body text&quot; | sudo mail -s &quot;Email subject line&quot; recipient@gmail.com -aFrom:kim</span>
</pre></div><p>The mail sender will be <code>kim@mail.snorl.ax</code> instaed, due to the default behaviour that mailutils append the hostname to usernames like this. Then the mail will be sent to <code>/var/mail/kim</code> instead. To change the appended domain to the desired <code>@snorl.ax</code>, create <code>/etc/mailutils.conf</code> with the setting:<div class=highlight><pre><span class=code-line><span></span>address {</span>
<span class=code-line>  email-domain snorl.ax;</span>
<span class=code-line>};</span>
</pre></div><p>Other configurable options can be seen via <code>$ mail --config-help</code>.<p>Now test SMTP using an Email Client like ThunderBird:<ul><li><strong>Username:</strong> <code>user@snorl.ax</code>, the login name of <code>kim@snorl.ax</code>.<li><strong>Password:</strong> The one I set above, not the encrypted string. The one before being encrypted.<li><strong>Server name:</strong> <code>mail.snorl.ax</code>, or the IP address of the server.<li><strong>SSL:</strong> <code>StartTls</code><li><strong>Port:</strong> 587</ul><h2 id=block-some-brute-forcers><a class=toclink href=#block-some-brute-forcers>Block some Brute Forcers</a></h2><p>Try looking into <code>/var/log/mail.log</code>:<div class=highlight><pre><span class=code-line><span></span>Jan 18 15:22:14 snorlax dovecot: auth-worker(5228): pam(tyler@snorl.ax,37.49.224.186): pam_authenticate() failed: Authentication failure (password mismatch?)</span>
</pre></div><p>It's normal that some IP I've never known keeps brute-forcing. Neither do I use any IP from that IP range.<p>Install the package to make the change permanent.<div class=highlight><pre><span class=code-line><span></span>$ sudo apt-get install iptables-persistent</span>
</pre></div><p>In this case, block the ip range might be a good idea:<div class=highlight><pre><span class=code-line><span></span>$ sudo iptables -A INPUT -s <span class=m>37</span>.49.224.0/24 -j DROP</span>
</pre></div><h2 id=hide-senders-ip-in-the-sent-mails-header><a class=toclink href=#hide-senders-ip-in-the-sent-mails-header>Hide sender's IP in the sent mail's header</a></h2><p>I'm using submission port. Uncomment and add and edit the relevant lines in <code>/etc/postfix/master.cf</code>, the relevant lines should look like this<sup id=fnref:9><a class=footnote-ref href=#fn:9 rel=footnote>8</a></sup>:<div class=highlight><pre><span class=code-line><span></span>submission inet n       -       -       -       -       smtpd</span>
<span class=code-line>  -o smtpd_tls_security_level=encrypt</span>
<span class=code-line>  -o smtpd_sasl_auth_enable=yes</span>
<span class=code-line>  -o smtpd_client_restrictions=permit_sasl_authenticated,reject</span>
<span class=code-line>  -o milter_macro_daemon_name=ORIGINATING</span>
<span class=code-line>  -o cleanup_service_name=subcleanup</span>
</pre></div><p>Pass <code>header_checks</code> to the new cleanup service in <code>/etc/postfix/master.cf</code>, relevant lines look like this:<div class=highlight><pre><span class=code-line><span></span>cleanup   unix  n       -       -       -       0       cleanup</span>
<span class=code-line>subcleanup unix n       -       -       -       0       cleanup</span>
<span class=code-line>  -o header_checks=regexp:/etc/postfix/submission_header_checks</span>
</pre></div><p>Create the file <code>/etc/postfix/submission_header_checks</code>, which will contain the regex that filters offending Received header lines.<p>If <code>smtpd_sasl_authenticated_header</code> is <code>yes</code>, then use this in the file:<div class=highlight><pre><span class=code-line><span></span>/^Received:.*\(Authenticated sender:/ IGNORE</span>
</pre></div><p>Otherwise(also by default when <code>smtpd_sasl_authenticated_header</code> is not set), use this in the file:<div class=highlight><pre><span class=code-line><span></span>/^Received:.*\(Postfix/ IGNORE</span>
</pre></div><p>Restart postfix to see the effect.<h2 id=integrate-spamassassin><a class=toclink href=#integrate-spamassassin>Integrate Spamassassin</a></h2><p>It's one of the most well-known mail spam filters. Speaking of spam filter, it can be regarded as the most mentioned<sup id=fnref:15><a class=footnote-ref href=#fn:15 rel=footnote>13</a></sup><sup id=fnref:17><a class=footnote-ref href=#fn:17 rel=footnote>15</a></sup>.<p>Install Spamassassin and its dependencies and dovecot-sieve.<div class=highlight><pre><span class=code-line><span></span>$ sudo apt install spamassassin spamc dovecot-sieve</span>
</pre></div><p>Start the service and enable it.<div class=highlight><pre><span class=code-line><span></span>$ sudo systemctl start spamassassin</span>
<span class=code-line>$ sudo systemctl <span class=nb>enable</span> spamassassin</span>
</pre></div><p>Modify <code>/etc/postfix/master.cf</code>:<ol><li><p>Change the smtp line to:<div class=highlight><pre><span class=code-line><span></span>smtp      inet  n       -       -       -       -       smtpd -o content_filter=spamassassin</span>
</pre></div><li><p>Add the following (a call to our newly-created spamfilter script) at the end:<div class=highlight><pre><span class=code-line><span></span>spamassassin unix -     n   n   -   -   pipe</span>
<span class=code-line>    flags=ROhu user=vmail:vmail argv=/usr/bin/spamc -f -e</span>
<span class=code-line>    /usr/lib/dovecot/deliver -f <span class=cp>${</span><span class=n>sender</span><span class=cp>}</span> -d <span class=cp>${</span><span class=n>user</span><span class=cp>}</span>@<span class=cp>${</span><span class=n>nexthop</span><span class=cp>}</span></span>
</pre></div><p>The flags flags=ROhu don't add anything abnormal but they can be understood <a href=http://www.postfix.org/pipe.8.html>here</a>.</ol><p>Modify <code>/etc/mail/spamassassin/local.cf</code> to include the following settings:<div class=highlight><pre><span class=code-line><span></span># Just add an X-Spam-Report header to suspected spam, rather than rewriting the content of the e-mail</span>
<span class=code-line>report_safe 0</span>
<span class=code-line># Also we want to add a detailed ham report header to even e-mail that ISN&#39;T suspected to be spam</span>
<span class=code-line>add_header ham HAM-Report _REPORT_</span>
<span class=code-line># Set the threshold at which a message is considered spam (3 is usually sufficient)</span>
<span class=code-line>required_score 3.0</span>
</pre></div><p>Modify <code>/etc/dovecot/conf.d/15-mailboxes.conf</code> to ensure the following lines are included(By default they are included):<div class=highlight><pre><span class=code-line><span></span>mailbox Junk {</span>
<span class=code-line>   special_use = \Junk</span>
<span class=code-line>}</span>
</pre></div><p>Edit <code>/etc/dovecot/conf.d/90-sieve.conf</code> and comment the line <code>sieve = ~/.dovecot.sieve</code>, like this:<div class=highlight><pre><span class=code-line>...</span>
<span class=code-line>plugin {</span>
<span class=code-line>  ...</span>
<span class=code-line>  <b>#sieve = file:~/sieve;active=~/.dovecot.sieve</b></pre></div><p>Edit <code>/etc/dovecot/conf.d/90-plugin.conf</code> as:<div class=highlight><pre><span class=code-line>...</span>
<span class=code-line>plugin {</span>
<span class=code-line>    ...</span>
<span class=code-line>    <b>sieve = /etc/dovecot/sieve/default.sieve</b></span>
<span class=code-line>}</pre></div><p>Edit <code>/etc/dovecot/conf.d/15-lda.conf</code>:<div class=highlight><pre><span class=code-line>protocol lda {</span>
<span class=code-line>  <b>mail_plugins = $mail_plugins sieve</b></span>
<span class=code-line>}</pre></div><p>Create folder <code>/etc/dovecot/sieve/</code>:<div class=highlight><pre><span class=code-line><span></span>$ mkdir /etc/dovecot/sieve/</span>
</pre></div><p>Create file <code>/etc/dovecot/sieve/default.sieve</code> with this content:<div class=highlight><pre><span class=code-line><span></span>require &quot;fileinto&quot;;</span>
<span class=code-line>if header :contains &quot;X-Spam-Flag&quot; &quot;YES&quot; {</span>
<span class=code-line>    fileinto &quot;Junk&quot;;</span>
<span class=code-line>}</span>
</pre></div><p>Change the folder permissions to the virtual email user and group like:<div class=highlight><pre><span class=code-line><span></span>$ chown vmail:vmail /etc/dovecot/sieve/ -R</span>
</pre></div><p>Restart postfix, dovecot and spamassassin.<div class=highlight><pre><span class=code-line><span></span>$ sudo systemctl restart spamassassin dovecot postfix</span>
</pre></div><p>Try sending a mail to the mail account. The output of <code>tail /var/log/mail.log</code> will be like:<div class=highlight><pre><span class=code-line>Jan 25 13:54:47 pelipper postfix/qmgr[23283]: 9C2C5DBBA7: from=&lt;yumsnorlax@gmail.com&gt;, size=3031, nrcpt=1 (queue active)</span>
<span class=code-line>Jan 25 13:54:47 pelipper spamd[23286]: spamd: connection from ::1 [::1]:33756 to port 783, fd 5</span>
<span class=code-line>Jan 25 13:54:47 pelipper spamd[23286]: spamd: setuid to vmail succeeded</span>
<span class=code-line>Jan 25 13:54:47 pelipper spamd[23286]: spamd: creating default_prefs: /var/mail/.spamassassin/user_prefs</span>
<span class=code-line>Jan 25 13:54:47 pelipper spamd[23286]: config: created user preferences file: /var/mail/.spamassassin/user_prefs</span>
<span class=code-line>Jan 25 13:54:47 pelipper spamd[23286]: spamd: processing message &lt;1548420881.1041.0@gmail.com&gt; for vmail:5000</span>
<span class=code-line>Jan 25 13:54:47 pelipper postfix/smtpd[23313]: disconnect from mail-pg1-x530.google.com[2607:f8b0:4864:20::530] ehlo=2 starttls=1 mail=1 rcpt=1 data=1 quit=1 commands=7</span>
<span class=code-line>Jan 25 13:54:49 pelipper spamd[23286]: spamd: clean message (0.9/3.0) for vmail:5000 in 2.7 seconds, 3164 bytes.</span>
<span class=code-line>Jan 25 13:54:49 pelipper spamd[23286]: spamd: result: . 0 - DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,FREEMAIL_FROM,HTML_MESSAGE,RCVD_IN_DNSWL_NONE,SPF_PASS,TRACKER_ID,TVD_SPACE_RATIO scantime=2.7,size=3164,user=vmail,uid=5000,required_score=3.0,rhost=::1,raddr=::1,rport=33756,mid=&lt;1548420881.1041.0@gmail.com&gt;,autolearn=no autolearn_force=no</span>
<span class=code-line>Jan 25 13:54:49 pelipper dovecot: lda(user2@snorl.ax): sieve: msgid=&lt;1548420881.1041.0@gmail.com&gt;: stored mail into mailbox 'INBOX'</span>
<span class=code-line>Jan 25 13:54:49 pelipper postfix/pipe[23326]: 9C2C5DBBA7: to=&lt;user2@snorl.ax&gt;, orig_to=&lt;kim@snorl.ax&gt;, relay=spamassassin, delay=3.3, delays=0.58/0.01/0/2.7, dsn=2.0.0, status=sent (delivered via spamassassin service)</span>
<span class=code-line>Jan 25 13:54:49 pelipper postfix/qmgr[23283]: 9C2C5DBBA7: removed</pre></div><p>Try sending another mail with this subject: <code>XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X</code>. The output of <code>tail /var/log/mail.log</code> will be like this:<div class=highlight><pre><span class=code-line>Jan 25 13:56:31 pelipper postfix/qmgr[23283]: 43CFADBBA7: from=&lt;yumsnorlax@gmail.com&gt;, size=3103, nrcpt=1 (queue active)</span>
<span class=code-line>Jan 25 13:56:31 pelipper spamd[23286]: spamd: connection from ::1 [::1]:33770 to port 783, fd 5</span>
<span class=code-line>Jan 25 13:56:31 pelipper spamd[23286]: spamd: setuid to vmail succeeded</span>
<span class=code-line>Jan 25 13:56:31 pelipper spamd[23286]: spamd: processing message &lt;1548420985.1041.1@gmail.com&gt; for vmail:5000</span>
<span class=code-line>Jan 25 13:56:31 pelipper postfix/smtpd[23334]: disconnect from mail-pl1-x62d.google.com[2607:f8b0:4864:20::62d] ehlo=2 starttls=1 mail=1 rcpt=1 data=1 quit=1 commands=7</span>
<span class=code-line>Jan 25 13:56:33 pelipper spamd[23286]: spamd: identified spam (999.8/3.0) for vmail:5000 in 2.4 seconds, 3235 bytes.</span>
<span class=code-line>Jan 25 13:56:33 pelipper spamd[23286]: spamd: result: Y 999 - DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,FREEMAIL_FROM,GTUBE,HTML_MESSAGE,RCVD_IN_DNSWL_NONE,SPF_PASS,TVD_SPACE_RATIO scantime=2.4,size=3235,user=vmail,uid=5000,required_score=3.0,rhost=::1,raddr=::1,rport=33770,mid=&lt;1548420985.1041.1@gmail.com&gt;,autolearn=no autolearn_force=no</span>
<span class=code-line>Jan 25 13:56:33 pelipper dovecot: lda(user2@snorl.ax): sieve: msgid=&lt;1548420985.1041.1@gmail.com&gt;: stored mail into mailbox 'Junk'</span>
<span class=code-line>Jan 25 13:56:34 pelipper postfix/pipe[23343]: 43CFADBBA7: to=&lt;user2@snorl.ax&gt;, orig_to=&lt;kim@snorl.ax&gt;, relay=spamassassin, delay=2.9, delays=0.46/0.01/0/2.4, dsn=2.0.0, status=sent (delivered via spamassassin service)</span>
<span class=code-line>Jan 25 13:56:34 pelipper postfix/qmgr[23283]: 43CFADBBA7: removed</pre></div><p>The spam filter is now working. A spam will go directly into the Junk Folder.<h3 id=solve-uribl_blocked><a class=toclink href=#solve-uribl_blocked>Solve URIBL_BLOCKED</a></h3><div class=highlight><pre><span class=code-line><span></span>X-Spam-HAM-Report:</span>
<span class=code-line>    *  0.0 URIBL_BLOCKED ADMINISTRATOR NOTICE: The query to URIBL was</span>
<span class=code-line>    *      blocked.  See</span>
<span class=code-line>    *      http://wiki.apache.org/spamassassin/DnsBlocklists#dnsbl-block</span>
<span class=code-line>    *      for more information.</span>
</pre></div><p>SpamAssassin will perform many DNS lookups for NetworkTests to significantly improve scoring of messages primarily by DNSBlocklists like Spamhaus, SORBS, etc. This information needs to be cached locally to improve performance and limit the number of external DNS queries since some DNSBlockLists have limits on free usage. A local DNS caching server should not forward to other DNS servers to ensure your queries are not combined with others. Forwarding to other DNS servers often results in URIBL_BLOCKED or similar rule hits meaning you have gone over their free usage limit.<sup id=fnref:16><a class=footnote-ref href=#fn:16 rel=footnote>14</a></sup><div class=highlight><pre><span class=code-line><span></span>$ sudo apt-get update</span>
<span class=code-line>$ sudo apt-get install unbound</span>
</pre></div><p>Then it is running and the corresponding service is enabled.<br>Add this to <code>/etc/spamassassin/local.cf</code>:<div class=highlight><pre><span class=code-line><span></span>dns_available yes</span>
<span class=code-line>dns_server 127.0.0.1</span>
</pre></div><p>Test it out. With these output it's now working.<p>Spamhaus Zen:<div class=highlight><pre><span class=code-line><span></span><span class=err>$</span> <span class=n>dig</span> <span class=o>+</span><span class=kt>short</span> <span class=mf>2.0.0.127</span><span class=p>.</span><span class=n>zen</span><span class=p>.</span><span class=n>spamhaus</span><span class=p>.</span><span class=n>org</span> <span class=mf>@127.0.0.1</span></span>
<span class=code-line><span class=mf>127.0.0.10</span></span>
<span class=code-line><span class=mf>127.0.0.4</span></span>
<span class=code-line><span class=mf>127.0.0.2</span></span>
</pre></div><p>SORBS DUL:<div class=highlight><pre><span class=code-line><span></span><span class=err>$</span> <span class=n>dig</span> <span class=mf>2.0.0.127</span><span class=p>.</span><span class=n>dul</span><span class=p>.</span><span class=n>dnsbl</span><span class=p>.</span><span class=n>sorbs</span><span class=p>.</span><span class=n>net</span> <span class=o>+</span><span class=kt>short</span> <span class=mf>@127.0.0.1</span></span>
<span class=code-line><span class=mf>127.0.0.10</span></span>
</pre></div><p>URIBL:<div class=highlight><pre><span class=code-line><span></span><span class=err>$</span> <span class=n>dig</span> <span class=n>test</span><span class=p>.</span><span class=n>uribl</span><span class=p>.</span><span class=n>com</span><span class=p>.</span><span class=n>multi</span><span class=p>.</span><span class=n>uribl</span><span class=p>.</span><span class=n>com</span> <span class=n>txt</span> <span class=o>+</span><span class=kt>short</span> <span class=mf>@127.0.0.1</span></span>
<span class=code-line><span class=s>&quot;permanent testpoint&quot;</span></span>
</pre></div><div class=footnote><hr><ol><li id=fn:1><p><a href=https://wiki2.dovecot.org/HowTo/DovecotPostgresql>HowTo/DovecotPostgresql - Dovecot Wiki</a>&#160;<a class=footnote-backref href=#fnref:1 rev=footnote title="Jump back to footnote 1 in the text">&#8617;</a><li id=fn:2><p><a href=https://www.linode.com/docs/email/postfix/email-with-postfix-dovecot-and-mysql/>Email with Postfix, Dovecot, and MySQL - Linode</a>&#160;<a class=footnote-backref href=#fnref:2 rev=footnote title="Jump back to footnote 2 in the text">&#8617;</a><li id=fn:3><p><a href=https://backports.debian.org/Instructions/>Debian Backports - Instructions</a>&#160;<a class=footnote-backref href=#fnref:3 rev=footnote title="Jump back to footnote 3 in the text">&#8617;</a><li id=fn:4><p><a href=https://serverfault.com/a/440616>centos - How do I change Dovecot virtual user passwords? - Server Fault</a>&#160;<a class=footnote-backref href=#fnref:4 rev=footnote title="Jump back to footnote 4 in the text">&#8617;</a><li id=fn:5><p><a href=https://wiki.dovecot.org/BasicConfiguration>BasicConfiguration - Dovecot Wiki</a>&#160;<a class=footnote-backref href=#fnref:5 rev=footnote title="Jump back to footnote 5 in the text">&#8617;</a><li id=fn:6><p><a href=http://www.postfix.org/SASL_README.html>Postfix SASL Howto</a>&#160;<a class=footnote-backref href=#fnref:6 rev=footnote title="Jump back to footnote 6 in the text">&#8617;</a><li id=fn:7><p><a href=https://www.linode.com/docs/email/postfix/configure-spf-and-dkim-in-postfix-on-debian-9/>Configure SPF and DKIM With Postfix on Debian 9</a>&#160;<a class=footnote-backref href=#fnref:7 rev=footnote title="Jump back to footnote 7 in the text">&#8617;</a><li id=fn:9><p><a href=https://askubuntu.com/a/78168>When sending email with Postfix, how can I hide the sender’s IP and username in the Received header?</a>&#160;<a class=footnote-backref href=#fnref:9 rev=footnote title="Jump back to footnote 8 in the text">&#8617;</a><li id=fn:10><p><a href=https://easyengine.io/tutorials/mail/fqdn-reverse-dns-ptr-mx-record-checks>Checking FQDN, Reverse-DNS/PTR, MX record</a>&#160;<a class=footnote-backref href=#fnref:10 rev=footnote title="Jump back to footnote 9 in the text">&#8617;</a><li id=fn:12><p><a href=http://www.postfix.org/postconf.5.html>Postfix Configuration Parameters</a>&#160;<a class=footnote-backref href=#fnref:12 rev=footnote title="Jump back to footnote 10 in the text">&#8617;</a><li id=fn:13><p><a href=https://wiki.dovecot.org/HowTo/CRAM-MD5>HowToCRAM/MD5 - Dovecot Wiki</a>&#160;<a class=footnote-backref href=#fnref:13 rev=footnote title="Jump back to footnote 11 in the text">&#8617;</a><li id=fn:14><p><a href=https://wiki1.dovecot.org/Authentication/PasswordSchemes>Authentication/PasswordSchemes - Dovecot Wiki</a>&#160;<a class=footnote-backref href=#fnref:14 rev=footnote title="Jump back to footnote 12 in the text">&#8617;</a><li id=fn:15><p><a href=https://wiki.apache.org/spamassassin/IntegratedSpamdInPostfix>IntegratedSpamdInPostfix - Spamassassin Wiki</a>&#160;<a class=footnote-backref href=#fnref:15 rev=footnote title="Jump back to footnote 13 in the text">&#8617;</a><li id=fn:16><p><a href=https://wiki.apache.org/spamassassin/CachingNameserver>CachingNameserver - Spamassassin Wiki</a>&#160;<a class=footnote-backref href=#fnref:16 rev=footnote title="Jump back to footnote 14 in the text">&#8617;</a><li id=fn:17><p><a href=https://stackoverflow.com/a/34571858/9850945>postfix mta - How to move spam to spam folder? - Stack Overflow</a>&#160;<a class=footnote-backref href=#fnref:17 rev=footnote title="Jump back to footnote 15 in the text">&#8617;</a><li id=fn:18><p><a href=https://wiki.dovecot.org/SSL/DovecotConfiguration>SSL/DovecotConfiguration - Dovecot Wiki</a>&#160;<a class=footnote-backref href=#fnref:18 rev=footnote title="Jump back to footnote 16 in the text">&#8617;</a><li id=fn:19><p><a href=http://www.postfix.org/LOCAL_RECIPIENT_README.html#format>Rejecting Unknown Local Recipients with Postfix</a>&#160;<a class=footnote-backref href=#fnref:19 rev=footnote title="Jump back to footnote 17 in the text">&#8617;</a></ol></div></div><footer id=q><svg id="publish"/><b>Created:&nbsp;</b><time datetime=2018-12-27T13:00:00+01:00>December 27, 2018</time><span id=y>•</span><svg id="edit"/><b>Updated:&nbsp;</b><time datetime=2019-05-28T13:14:00+02:00>May 28, 2019</time><span id=y>•</span><svg id="session"/></svg>In a <a href=https://archives.snorl.ax/terminal/ rel="category tag"><b>Terminal</b></a> Session<span id=y>•</span><svg id="tags"/><b>Tags:&nbsp;</b><a href=https://archives.snorl.ax/tags/email/ rel=tag>email</a>,&nbsp;<a href=https://archives.snorl.ax/tags/postfix/ rel=tag>postfix</a>,&nbsp;<a href=https://archives.snorl.ax/tags/dovecot/ rel=tag>dovecot</a>,&nbsp;<a href=https://archives.snorl.ax/tags/saslauthd/ rel=tag>saslauthd</a>,&nbsp;<a href=https://archives.snorl.ax/tags/debian/ rel=tag>Debian</a>,&nbsp;<a href=https://archives.snorl.ax/tags/imap/ rel=tag>imap</a>,&nbsp;<a href=https://archives.snorl.ax/tags/smtp/ rel=tag>smtp</a>,&nbsp;<a href=https://archives.snorl.ax/tags/sendgrid/ rel=tag>SendGrid</a>,&nbsp;<a href=https://archives.snorl.ax/tags/amazon-ses/ rel=tag>Amazon SES</a>,&nbsp;<a href=https://archives.snorl.ax/tags/dkim/ rel=tag>dkim</a>,&nbsp;<a href=https://archives.snorl.ax/tags/spf/ rel=tag>spf</a>,&nbsp;<a href=https://archives.snorl.ax/tags/dmarc/ rel=tag>dmarc</a>,&nbsp;<a href=https://archives.snorl.ax/tags/mailutils/ rel=tag>mailutils</a>,&nbsp;<a href=https://archives.snorl.ax/tags/spamassassin/ rel=tag>spamassassin</a></footer></article><article id=m><div id=n><section id=comments data-title="Running email service on my own server!" data-isso-id=/drafts/running-email-service-on-my-own-server.html></section></div></article></main></div><footer id=g><div id=l>Simputer Archives &#169; 2016 - 2019 (<a href=https://snorl.ax/>Click to view Current Version of Simputer</a>) • Licensed under <a target=_blank rel=license href=http://creativecommons.org/licenses/by/3.0/>CC BY 3.0</a><br>Made using <a href=http://getpelican.com/ target=_blank>Pelican</a> • Design from <a href=https://wordpress.org/themes/twentyfifteen/ target=_blank>TwentyFifteen</a></div></footer><script data-isso=https://isso.snorl.ax/ data-isso-gravatar=true data-isso-avatar=false data-isso-reply-notifications=true data-isso-reply-to-self=true data-isso-css=false src=https://archives.snorl.ax/theme/js/isso_embed.min.js data-isso-lang=en></script>