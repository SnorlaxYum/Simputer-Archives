<!doctype html><html lang=en><title>Add Brotli To Nginx On Debian Stretch - Terminal In A Simputer Archives</title><meta charset=utf-8><link rel=canonical href=https://archives.snorl.ax/drafts/add-brotli-to-nginx-on-debian-stretch.html><link href=https://archives.snorl.ax/theme/css/all.css rel=stylesheet><link rel=dns-prefetch href=https://fonts.googleapis.com><link rel=dns-prefetch href=https://fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Luckiest+Guy|Rajdhani:600|Rajdhani:700&amp;display=swap"><link href=https://archives.snorl.ax/theme/images/icon.png rel=icon><link href=https://archives.snorl.ax/theme/images/icon-apple.png rel=apple-touch-icon-precomposed><link href=https://archives.snorl.ax/feeds/all.xml rel=alternate title="Simputer Archives RSS Feed" type=application/rss+xml><meta content=brotli name=tags><meta content=nginx name=tags><meta content="width=device-width" name=viewport><meta name=twitter:card content=summary><meta name=twitter:image content=https://archives.snorl.ax/theme/images/usual-twitter.png><meta name=twitter:site content=@Snorl_ax><meta name=twitter:title content="Add Brotli To Nginx On Debian Stretch"><meta name=twitter:description content=Owch........><div id=a><header id=c><div id=d><h1 id=e><a href=https://archives.snorl.ax/>Simputer Archives</a></h1></div></header><div id=f><nav id=h><ul><li><a href=https://archives.snorl.ax/>Home</a><li><a href=https://archives.snorl.ax/browser/>Browser</a><li id=i><a href=https://archives.snorl.ax/terminal/>Terminal</a><li><a href=https://archives.snorl.ax/tags/>Tags</a></ul></nav><nav id=r><a href=https://www.youtube.com/channel/UCnqOLMtPJaqa7e_6FhZ8-rw title=Youtube><svg id="youtube"/></a><a href=https://github.com/SnorlaxYum/ title=Github><svg id="github"/></a><a href=https://twitter.com/Snorl_ax title=Twitter><svg id="twitter"/></a><a href=https://archives.snorl.ax/feeds/all.xml title=RSS><svg id="rss"/></a><a href=mailto:sim@snorl.ax title=Email><svg id="mail"/></a></nav><aside id=j><form action=https://archives.snorl.ax/search.html onsubmit="return validateForm(this.elements['q'].value);"><input placeholder=Search... name=q id=tipue_search_input></form></aside></div></div><div id=b><main id=k><article id=m><header id=o><h2 id=p>Add Brotli To Nginx On Debian Stretch</h2></header><div id=n><h2 id=toc>Table Of Contents</h2><div class=toc><ul><li><a href=#installation>Installation</a><li><a href=#brotli-basic-settings>Brotli: Basic Settings</a><li><a href=#brotli-more-on-settings>Brotli: More ON settings</a></ul></div><h2 id=installation><a class=toclink href=#installation>Installation</a></h2><p>Normally I just install nginx this way:<p>Add the lines to <code>/etc/apt/sources.list</code>:<div class=highlight><pre><span class=code-line><span></span><span class=k>deb</span> <span class=s>http://nginx.org/packages/mainline/debian/</span> <span class=kp>stretch</span> <span class=kp>nginx</span></span>
<span class=code-line><span class=k>deb-src</span> <span class=s>http://nginx.org/packages/mainline/debian/</span> <span class=kp>stretch</span> <span class=kp>nginx</span></span>
</pre></div><p>If the key hasn't been added, add it:<div class=highlight><pre><span class=code-line><span></span>sim@server:~$ wget https://nginx.org/keys/nginx_signing.key &amp;&amp; sudo apt-key add nginx_signing.key</span>
</pre></div><p>Then install it:<div class=highlight><pre><span class=code-line><span></span>sim@server:~$ sudo apt update &amp;&amp; sudo apt install nginx</span>
</pre></div><h2 id=brotli-basic-settings><a class=toclink href=#brotli-basic-settings>Brotli: Basic Settings</a></h2><p>THe brotli is not included in the prebuilt package. So I have to build it from source.<sup id=fnref:1><a class=footnote-ref href=#fn:1 rel=footnote>1</a></sup><p>Get the source:<div class=highlight><pre><span class=code-line><span></span>sim@server:~$ sudo apt source nginx</span>
</pre></div><p>Then clone <code>ngx_brotli</code> from github:<div class=highlight><pre><span class=code-line><span></span>sim@server:~$ git clone https://github.com/eustas/ngx_brotli.git</span>
<span class=code-line>sim@server:~$ cd ngx_brotli &amp;&amp; git submodule update --init &amp;&amp; cd ~</span>
</pre></div><p>Install the build dependencies:<div class=highlight><pre><span class=code-line><span></span>sim@server:~$ sudo apt build-dep nginx</span>
</pre></div><p>Make the modules and copy it to the right place:<div class=highlight><pre><span class=code-line><span></span>sim@server:~$ cd ~/nginx-*</span>
<span class=code-line>sim@server:~/nginx-1.17.0$ ./configure --with-compat --add-dynamic-module=../ngx_brotli</span>
<span class=code-line>sim@server:~/nginx-1.17.0$ make modules</span>
<span class=code-line>sim@server:~/nginx-1.17.0$ sudo cp objs/*.so /usr/lib/nginx/modules</span>
</pre></div><p><code>/etc/nginx/nginx.conf</code>:<div class=highlight><pre><span class=code-line><span></span>load_module modules/ngx_http_brotli_filter_module.so;</span>
<span class=code-line>load_module modules/ngx_http_brotli_static_module.so;</span>
<span class=code-line>...</span>
</pre></div><p>Include the lines in server blocks that need the brotli:<div class=highlight><pre><span class=code-line><span></span>server {</span>
<span class=code-line>  ...</span>
<span class=code-line>  brotli on;</span>
<span class=code-line>  brotli_static on;</span>
<span class=code-line>  brotli_types *;</span>
<span class=code-line>  ...</span>
<span class=code-line>}</span>
</pre></div><p>Don't include the lines in http block directly since it will force all the server blocks to use brotli, which will a nightmire when it affects a backend server...... Things like brotli should be only used in frontend server blocks.<p>Restart nginx:<div class=highlight><pre><span class=code-line><span></span>sim@server:~/nginx-1.17.0$ sudo systemctl restart nginx</span>
</pre></div><p>The other third party modules not included in the prebuilt package can be installed this way as well.<h2 id=brotli-more-on-settings><a class=toclink href=#brotli-more-on-settings>Brotli: More ON settings</a></h2><p>The following settings might be useful due to the following reasons<sup id=fnref:2><a class=footnote-ref href=#fn:2 rel=footnote>2</a></sup>:<ol><li>Brotli with setting 4 is both significantly smaller AND compresses faster than gzip<li>Brotli is made text-based file formats like HTML (included by default), plaintext, JavaScript, JSON, SVG and RSS<li>Pre-compress the static formats so these can be served immediately for every request</ol><p>But it is not useful for me when I'm using <code>proxy_pass</code> to a backend from a frontend. So <code>brotli_static</code> means nothing when I fetch the files from another server. Proxying static files lowers the speed. I'd rather upload files to multiple servers (<a href=https://archives.snorl.ax/drafts/git-an-excellent-file-transferer.html#toc>My way of doing this via Git</a>).<p><code>/etc/nginx/conf.d/default.conf</code>:<div class=highlight><pre><span class=code-line><span></span>load_module modules/ngx_http_brotli_filter_module.so;</span>
<span class=code-line>load_module modules/ngx_http_brotli_static_module.so;</span>
<span class=code-line></span>
<span class=code-line>...</span>
<span class=code-line>server {</span>
<span class=code-line>  server_name snorl.ax;</span>
<span class=code-line>  ...</span>
<span class=code-line>  brotli on;</span>
<span class=code-line>  brotli_comp_level 4;</span>
<span class=code-line>  brotli_types text/plain text/css application/javascript application/json image/svg+xml application/xml+rss;</span>
<span class=code-line></span>
<span class=code-line>  brotli_static on;</span>
<span class=code-line>  ...</span>
<span class=code-line>}</span>
</pre></div><p>The site is generated by Pelican, a static site generator, which means the site files are mostly text-based formats. So a bash is made to process them before the files are published:<div class=highlight><pre><span class=code-line><span></span><span class=ch>#!/bin/bash</span></span>
<span class=code-line></span>
<span class=code-line><span class=k>for</span> FILE in <span class=k>$(</span>find public -type f -iname <span class=s1>&#39;*.css&#39;</span> -o -iname <span class=s1>&#39;*.js&#39;</span> -o -iname <span class=s1>&#39;*.svg&#39;</span> -o -iname <span class=s1>&#39;*.json&#39;</span> -o -iname <span class=s1>&#39;*.html&#39;</span> -o -iname <span class=s1>&#39;*.xml&#39;</span><span class=k>)</span><span class=p>;</span> <span class=k>do</span></span>
<span class=code-line>    <span class=nb>echo</span> -n <span class=s2>&quot;Compressing </span><span class=si>${</span><span class=nv>FILE</span><span class=si>}</span><span class=s2>...&quot;</span></span>
<span class=code-line>    brotli -f <span class=si>${</span><span class=nv>FILE</span><span class=si>}</span> -o <span class=si>${</span><span class=nv>FILE</span><span class=si>}</span>.br<span class=p>;</span></span>
<span class=code-line>    <span class=nb>echo</span> <span class=s2>&quot;done.&quot;</span></span>
<span class=code-line><span class=k>done</span></span>
</pre></div><p>Then after publishing the files, the pre-processed <code>.br</code>s will be served.<div class=footnote><hr><ol><li id=fn:1><p><a href=https://www.vultr.com/docs/add-brotli-support-to-nginx-on-ubuntu-18-04>Add Brotli support to Nginx on Ubuntu 18.04 - Vultr.com</a>&#160;<a class=footnote-backref href=#fnref:1 rev=footnote title="Jump back to footnote 1 in the text">&#8617;</a><li id=fn:2><p><a href=https://certsimple.com/blog/nginx-brotli>CertSimple | 'You can't use Brotli for dynamic content'</a>&#160;<a class=footnote-backref href=#fnref:2 rev=footnote title="Jump back to footnote 2 in the text">&#8617;</a></ol></div></div><footer id=q><svg id="publish"/><b>Created:&nbsp;</b><time datetime=2019-06-07T21:08:00+02:00>June 07, 2019</time><span id=y>•</span><svg id="edit"/><b>Updated:&nbsp;</b><time datetime=2019-06-12T12:30:00+02:00>June 12, 2019</time><span id=y>•</span><svg id="session"/></svg>In a <a href=https://archives.snorl.ax/terminal/ rel="category tag"><b>Terminal</b></a> Session<span id=y>•</span><svg id="tags"/><b>Tags:&nbsp;</b><a href=https://archives.snorl.ax/tags/brotli/ rel=tag>brotli</a>,&nbsp;<a href=https://archives.snorl.ax/tags/nginx/ rel=tag>nginx</a></footer></article><article id=m><div id=n><section id=comments data-title="Add Brotli To Nginx On Debian Stretch" data-isso-id=/drafts/add-brotli-to-nginx-on-debian-stretch.html></section></div></article></main></div><footer id=g><div id=l>Simputer Archives &#169; 2016 - 2019 (<a href=https://snorl.ax/>Click to view Current Version of Simputer</a>) • Licensed under <a target=_blank rel=license href=http://creativecommons.org/licenses/by/3.0/>CC BY 3.0</a><br>Made using <a href=http://getpelican.com/ target=_blank>Pelican</a> • Design from <a href=https://wordpress.org/themes/twentyfifteen/ target=_blank>TwentyFifteen</a></div></footer><script data-isso=https://isso.snorl.ax/ data-isso-gravatar=true data-isso-avatar=false data-isso-reply-notifications=true data-isso-reply-to-self=true data-isso-css=false src=https://archives.snorl.ax/theme/js/isso_embed.min.js data-isso-lang=en></script>