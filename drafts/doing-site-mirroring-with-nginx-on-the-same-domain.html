<!doctype html><html lang=en><title>Doing site mirroring with nginx on the same domain - Terminal In A Simputer Archives</title><meta charset=utf-8><link rel=canonical href=https://archives.snorl.ax/drafts/doing-site-mirroring-with-nginx-on-the-same-domain.html><link href=https://archives.snorl.ax/theme/css/all.css rel=stylesheet><link rel=dns-prefetch href=https://fonts.googleapis.com><link rel=dns-prefetch href=https://fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Luckiest+Guy|Rajdhani:600|Rajdhani:700&amp;display=swap"><link href=https://archives.snorl.ax/theme/images/icon.png rel=icon><link href=https://archives.snorl.ax/theme/images/icon-apple.png rel=apple-touch-icon-precomposed><link href=https://archives.snorl.ax/feeds/all.xml rel=alternate title="Simputer Archives RSS Feed" type=application/rss+xml><meta content=nginx name=tags><meta content=load balancing name=tags><meta content=PerfOps name=tags><meta content=cloudflare name=tags><meta content="width=device-width" name=viewport><meta name=twitter:card content=summary><meta name=twitter:image content=https://archives.snorl.ax/theme/images/usual-twitter.png><meta name=twitter:site content=@Snorl_ax><meta name=twitter:title content="Doing site mirroring with nginx on the same domain"><meta name=twitter:description content="Hmm, found a way to do that."><div id=a><header id=c><div id=d><h1 id=e><a href=https://archives.snorl.ax/>Simputer Archives</a></h1></div></header><div id=f><nav id=h><ul><li><a href=https://archives.snorl.ax/>Home</a><li><a href=https://archives.snorl.ax/browser/>Browser</a><li id=i><a href=https://archives.snorl.ax/terminal/>Terminal</a><li><a href=https://archives.snorl.ax/tags/>Tags</a></ul></nav><nav id=r><a href=https://www.youtube.com/channel/UCnqOLMtPJaqa7e_6FhZ8-rw title=Youtube><svg id="youtube"/></a><a href=https://github.com/SnorlaxYum/ title=Github><svg id="github"/></a><a href=https://twitter.com/Snorl_ax title=Twitter><svg id="twitter"/></a><a href=https://archives.snorl.ax/feeds/all.xml title=RSS><svg id="rss"/></a><a href=mailto:sim@snorl.ax title=Email><svg id="mail"/></a></nav><aside id=j><form action=https://archives.snorl.ax/search.html onsubmit="return validateForm(this.elements['q'].value);"><input placeholder=Search... name=q id=tipue_search_input></form></aside></div></div><div id=b><main id=k><article id=m><header id=o><h2 id=p>Doing site mirroring with nginx on the same domain</h2></header><div id=n><p>Since I have got two differnt servers (one in Finland, one in Los Angeles) I wanna load balance my site using nginx.<h2 id=toc>Table Of Contents</h2><div class=toc><ul><li><a href=#basic-settings>Basic settings</a><li><a href=#proxy_cache-for-them>proxy_cache for them</a><li><a href=#load-balancing-the-servers>Load Balancing the servers</a><ul><li><a href=#load-balancer-cname>Load Balancer CNAME</a><li><a href=#geodns>GeoDNS</a></ul></ul></div><h2 id=basic-settings><a class=toclink href=#basic-settings>Basic settings</a></h2><p>I don't recommend proxying static files. Instead, upload the files to both servers and serve them directly from each server. (<a href=https://archives.snorl.ax/drafts/git-an-excellent-file-transferer.html#toc>My method of doing this</a>) In this way no need in putting up with the latency from fetching files......<p>The way here only applies to a backend needing updating dynamically.<p>Having been searching a long way, I've found that it's viable via a port.<p><code>/etc/nginx/conf.d/default.conf</code>:<div class=highlight><pre><span class=code-line><span></span>server {</span>
<span class=code-line>  listen 443 ssl http2;</span>
<span class=code-line>  server_name snorl.ax;</span>
<span class=code-line>  ...site-configurations...</span>
<span class=code-line>}</span>
</pre></div><p>I could separate it into two parts, for example I'm gonna use port 123 on the main server:<div class=highlight><pre><span class=code-line><span></span><span class=nt>server</span> <span class=p>{</span></span>
<span class=code-line>  <span class=err>listen</span> <span class=err>123</span><span class=p>;</span></span>
<span class=code-line>  <span class=err>server_name</span> <span class=err>_</span><span class=p>;</span></span>
<span class=code-line>  <span class=err>if</span> <span class=err>($host</span> <span class=err>!~</span> <span class=err>snorl.ax)</span> <span class=err>{</span></span>
<span class=code-line>    <span class=err>return</span> <span class=err>444</span><span class=p>;</span></span>
<span class=code-line>  <span class=p>}</span></span>
<span class=code-line>  <span class=nt>if</span> <span class=o>($</span><span class=nt>http_custom</span> <span class=o>!~</span> <span class=nt>acustomheader</span><span class=o>)</span> <span class=p>{</span></span>
<span class=code-line>    <span class=err>return</span> <span class=err>444</span><span class=p>;</span></span>
<span class=code-line>  <span class=p>}</span></span>
<span class=code-line>  <span class=o>..</span><span class=p>.</span><span class=nc>site-configurations</span><span class=o>,</span> <span class=nt>use</span> <span class=o>$</span><span class=nt>host</span> <span class=nt>variable</span> <span class=nt>where</span> <span class=nt>I</span> <span class=nt>originally</span> <span class=nt>use</span> <span class=o>$</span><span class=nt>server_name</span><span class=o>...</span></span>
<span class=code-line>  <span class=nt>location</span> <span class=o>^~</span> <span class=o>/</span><span class=nt>isso</span> <span class=p>{</span></span>
<span class=code-line>    <span class=err>include</span>         <span class=err>uwsgi_params</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>uwsgi_pass</span> <span class=n>unix</span><span class=p>:</span><span class=o>///</span><span class=n>tmp</span><span class=o>/</span><span class=n>isso</span><span class=o>/</span><span class=n>uwsgi</span><span class=o>.</span><span class=n>sock</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>uwsgi_param</span> <span class=err>HTTP_X_SCRIPT_NAME</span> <span class=err>/isso</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>uwsgi_param</span> <span class=err>HTTP_HOST</span> <span class=err>$host</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>uwsgi_param</span> <span class=err>HTTP_X_REAL_IP</span> <span class=err>$http_x_real_ip</span><span class=p>;</span></span>
<span class=code-line>  <span class=p>}</span></span>
<span class=code-line><span class=err>}</span></span>
<span class=code-line></span>
<span class=code-line><span class=nt>server</span> <span class=p>{</span></span>
<span class=code-line>  <span class=err>listen</span> <span class=err>443</span> <span class=err>ssl</span> <span class=err>http2</span><span class=p>;</span></span>
<span class=code-line>  <span class=err>server_name</span> <span class=err>snorl.ax</span><span class=p>;</span></span>
<span class=code-line></span>
<span class=code-line>  <span class=err>location</span> <span class=err>^~</span> <span class=err>/</span> <span class=err>{</span></span>
<span class=code-line>    <span class=err>proxy_pass</span> <span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>localhost</span><span class=o>:</span><span class=mi>123</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>Host</span> <span class=err>$host</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>X-Forwarded-For</span> <span class=err>$proxy_add_x_forwarded_for</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>X-Forwarded-Proto</span> <span class=err>$scheme</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>Custom</span> <span class=err>acustomheader</span><span class=p>;</span></span>
<span class=code-line>  <span class=p>}</span></span>
<span class=code-line></span>
<span class=code-line>  <span class=nt>location</span> <span class=o>^~</span> <span class=o>/</span><span class=nt>isso</span> <span class=p>{</span></span>
<span class=code-line>    <span class=err>uwsgi_pass</span> <span class=n>unix</span><span class=p>:</span><span class=o>///</span><span class=n>tmp</span><span class=o>/</span><span class=n>isso</span><span class=o>/</span><span class=n>uwsgi</span><span class=o>.</span><span class=n>sock</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>uwsgi_param</span> <span class=err>HTTP_X_SCRIPT_NAME</span> <span class=err>/isso</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>uwsgi_param</span> <span class=err>HTTP_HOST</span> <span class=err>$host</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>uwsgi_param</span> <span class=err>HTTP_X_FORWARDED_FOR</span> <span class=err>$proxy_add_x_forwarded_for</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>include</span>         <span class=err>uwsgi_params</span><span class=p>;</span></span>
<span class=code-line>  <span class=p>}</span></span>
<span class=code-line></span>
<span class=code-line><span class=err>}</span></span>
</pre></div><p>The <code>^~</code> ensures that the static files are loaded correctly<sup id=fnref:1><a class=footnote-ref href=#fn:1 rel=footnote>1</a></sup>.<p>The two <code>if</code><sup id=fnref:4><a class=footnote-ref href=#fn:4 rel=footnote>4</a></sup> blocks ensure the <code>Host</code> header received<sup id=fnref:5><a class=footnote-ref href=#fn:5 rel=footnote>5</a></sup> is <code>snorl.ax</code> and <code>Custom</code> is <code>acustomheader</code>. Otherwise the server will return an error page, denying the further access.<p><code>X-Forwarded-For</code> is useful when it comes to the true IP of the client. Be sure to include the lines in the http block in <code>/etc/nginx/nginx.conf</code> on the main server:<div class=highlight><pre><span class=code-line><span></span>http {</span>
<span class=code-line>  ...</span>
<span class=code-line>  set_real_ip_from the_second_server_ip;</span>
<span class=code-line>  real_ip_header X-Forwrded-For;</span>
<span class=code-line>}</span>
</pre></div><p>Be sure to include this in <code>/etc/nginx/nginx.conf</code> in the http block:<div class=highlight><pre><span class=code-line><span></span>http {</span>
<span class=code-line>  ...</span>
<span class=code-line>  port_in_redirect off;</span>
<span class=code-line>  ...</span>
<span class=code-line>}</span>
</pre></div><p>Thus it'll support adding a trailing slash through proxy_pass if there's none, without redirecting the user to a url like <code>url:port/uri</code>.<sup id=fnref:7><a class=footnote-ref href=#fn:7 rel=footnote>7</a></sup><p>Then reload on this server:<div class=highlight><pre><span class=code-line><span></span>sim@server:~$ sudo systemctl reload nginx</span>
</pre></div><p><code>/etc/nginx/conf.d/default.conf</code> on the second server:<div class=highlight><pre><span class=code-line><span></span><span class=nt>server</span> <span class=p>{</span></span>
<span class=code-line>  <span class=err>listen</span> <span class=err>443</span> <span class=err>ssl</span> <span class=err>http2</span><span class=p>;</span></span>
<span class=code-line>  <span class=err>server_name</span> <span class=err>snorl.ax</span><span class=p>;</span></span>
<span class=code-line></span>
<span class=code-line>  <span class=err>location</span> <span class=err>^~</span> <span class=err>/</span> <span class=err>{</span></span>
<span class=code-line>    <span class=err>proxy_pass</span> <span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>external_ip_of_main</span><span class=o>:</span><span class=mi>123</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>Host</span> <span class=err>$host</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>X-Forwarded-For</span> <span class=err>$proxy_add_x_forwarded_for</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>X-Forwarded-Proto</span> <span class=err>$scheme</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>Custom</span> <span class=err>acustomheader</span><span class=p>;</span></span>
<span class=code-line>  <span class=p>}</span></span>
<span class=code-line><span class=err>}</span></span>
</pre></div><p>It is allowed to proxy the the apps like isso in the first server block of the first server on this server. As I said above, <code>X-Forwarded-For</code> is useful when it comes to the true IP of the client.<p><code>X-Forwarded-Proto</code> make the scheme the same with the proxy frontend (In this case, it's <code>https</code> rather than the <code>http</code> of the backend).<p>Be sure to include this in <code>/etc/nginx/nginx.conf</code> in the http block as well for the same reason above:<div class=highlight><pre><span class=code-line><span></span>http {</span>
<span class=code-line>  ...</span>
<span class=code-line>  port_in_redirect off;</span>
<span class=code-line>  ...</span>
<span class=code-line>}</span>
</pre></div><p>Reload on this server:<div class=highlight><pre><span class=code-line><span></span>sim@server:~$ sudo systemctl reload nginx</span>
</pre></div><h2 id=proxy_cache-for-them><a class=toclink href=#proxy_cache-for-them><code>proxy_cache</code> for them</a></h2><p>This could improve site performance a lot if many static files from the backend need proxying. However as I said before, it's recommended to upload the files to both servers and serve them directly from each server. Files from the same server can be more easy to control and enjoy features like <code>brotli_static</code>. So in a way <code>proxy_cache</code> kinda sucks for static files in my opinion.<p>For example, on the second server, I want to use cache for the paths other than <code>/isso</code> with longer caching expiration period for <code>/img</code> folder, my settings will be like this:<div class=highlight><pre><span class=code-line><span></span><span class=nt>proxy_cache_path</span>  <span class=o>/</span><span class=nt>etc</span><span class=o>/</span><span class=nt>nginx</span><span class=o>/</span><span class=nt>cache</span>  <span class=nt>levels</span><span class=o>=</span><span class=nt>1</span><span class=p>:</span><span class=nd>2</span>    <span class=nt>keys_zone</span><span class=o>=</span><span class=nt>snorlax</span><span class=p>:</span><span class=nd>10m</span></span>
<span class=code-line><span class=nt>inactive</span><span class=o>=</span><span class=nt>24h</span>  <span class=nt>max_size</span><span class=o>=</span><span class=nt>1g</span><span class=o>;</span></span>
<span class=code-line><span class=nt>server</span> <span class=p>{</span></span>
<span class=code-line>  <span class=err>...</span></span>
<span class=code-line>  <span class=err>server_name</span> <span class=err>snorl.ax</span><span class=p>;</span></span>
<span class=code-line>  <span class=err>...</span></span>
<span class=code-line><span class=err>#</span> <span class=n>Default</span><span class=p>:</span> <span class=n>expires</span> <span class=n>in</span> <span class=mi>1</span> <span class=n>hour</span></span>
<span class=code-line><span class=n>location</span> <span class=o>^~</span> <span class=o>/</span> <span class=err>{</span></span>
<span class=code-line>    <span class=n>proxy_pass</span> <span class=n>http</span><span class=o>://</span><span class=n>external_ip_of_main</span><span class=o>:</span><span class=mi>123</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>Host</span> <span class=err>$host</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>Custom</span> <span class=err>acustomheader</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>X-Forwarded-For</span> <span class=err>$proxy_add_x_forwarded_for</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>X-Forwarded-Proto</span> <span class=err>$scheme</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_buffering</span>        <span class=err>on</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_revalidate</span> <span class=err>on</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache</span>            <span class=err>snorlax</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_valid</span>      <span class=err>200</span>  <span class=err>1h</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_use_stale</span>  <span class=err>error</span> <span class=err>timeout</span> <span class=err>invalid_header</span> <span class=err>updating</span></span>
<span class=code-line>                           <span class=err>http_500</span> <span class=err>http_502</span> <span class=err>http_503</span> <span class=err>http_504</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_background_update</span> <span class=err>on</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_lock</span> <span class=err>on</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>add_header</span> <span class=err>X-Cache-Status</span> <span class=err>$upstream_cache_status</span><span class=p>;</span></span>
<span class=code-line></span>
<span class=code-line><span class=p>}</span></span>
<span class=code-line></span>
<span class=code-line><span class=err>#</span> <span class=o>/</span><span class=nt>isso</span> <span class=nt>path</span><span class=o>:</span> <span class=nt>Micro-caching</span> <span class=nt>for</span> <span class=nt>faster</span> <span class=nt>speed</span> <span class=nt>and</span> <span class=nt>less</span> <span class=nt>loads</span> <span class=nt>on</span> <span class=nt>the</span> <span class=nt>origin</span></span>
<span class=code-line><span class=nt>location</span> <span class=o>^~</span> <span class=o>/</span><span class=nt>isso</span> <span class=p>{</span></span>
<span class=code-line>    <span class=err>proxy_pass</span> <span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>external_ip_of_main</span><span class=o>:</span><span class=mi>123</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>Host</span> <span class=err>$host</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>Custom</span> <span class=err>acustomheader</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_buffering</span>        <span class=err>off</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_revalidate</span> <span class=err>on</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache</span>            <span class=err>snorlax</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_valid</span>      <span class=err>200</span> <span class=err>404</span> <span class=err>1s</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_use_stale</span>  <span class=err>updating</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_background_update</span> <span class=err>on</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_lock</span> <span class=err>on</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>Host</span> <span class=err>$host</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>X-Forwarded-For</span> <span class=err>$proxy_add_x_forwarded_for</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>X-Forwarded-Proto</span> <span class=err>$scheme</span><span class=p>;</span></span>
<span class=code-line><span class=p>}</span></span>
<span class=code-line></span>
<span class=code-line><span class=err>#</span> <span class=o>/</span><span class=nt>img</span> <span class=nt>path</span><span class=o>:</span> <span class=nt>expires</span> <span class=nt>in</span> <span class=nt>1</span> <span class=nt>year</span><span class=o>.</span></span>
<span class=code-line></span>
<span class=code-line><span class=nt>location</span> <span class=o>^~</span> <span class=o>/</span><span class=nt>img</span> <span class=p>{</span></span>
<span class=code-line>    <span class=err>proxy_pass</span> <span class=n>http</span><span class=p>:</span><span class=o>//</span><span class=n>external_ip_of_main</span><span class=o>:</span><span class=mi>123</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>Host</span> <span class=err>$host</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_set_header</span> <span class=err>Custom</span> <span class=err>acustomheader</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_buffering</span>        <span class=err>on</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_revalidate</span> <span class=err>on</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache</span>            <span class=err>snorlax</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_valid</span>      <span class=err>200</span>  <span class=err>1y</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_use_stale</span>  <span class=err>error</span> <span class=err>timeout</span> <span class=err>invalid_header</span> <span class=err>updating</span></span>
<span class=code-line>                           <span class=err>http_500</span> <span class=err>http_502</span> <span class=err>http_503</span> <span class=err>http_504</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_background_update</span> <span class=err>on</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>proxy_cache_lock</span> <span class=err>on</span><span class=p>;</span></span>
<span class=code-line>    <span class=err>add_header</span> <span class=err>X-Cache-Status</span> <span class=err>$upstream_cache_status</span><span class=p>;</span></span>
<span class=code-line><span class=p>}</span></span>
<span class=code-line><span class=o>...</span></span>
<span class=code-line><span class=err>}</span></span>
</pre></div><p>For the details about these settings, check the official guide<sup id=fnref:6><a class=footnote-ref href=#fn:6 rel=footnote>6</a></sup>.<p>Then create a directory for it and reload:<div class=highlight><pre><span class=code-line><span></span>sim@server:~$ sudo mkdir /etc/nginx/cache</span>
<span class=code-line>sim@server:~$ sudo chown -R nginx:nginx /etc/nginx/cache</span>
<span class=code-line>sim@server:~$ sudo systemctl reload nginx</span>
</pre></div><h2 id=load-balancing-the-servers><a class=toclink href=#load-balancing-the-servers>Load Balancing the servers</a></h2><p>Two choices for it: Load Balancer CNAME, GeoDNS.<h3 id=load-balancer-cname><a class=toclink href=#load-balancer-cname>Load Balancer CNAME</a></h3><p>Cloudflare has this and charges it for at least 5 dollars a month just for subscription fee. Then they will charge according to the bandwidth usage.<p>Another choice<sup id=fnref:2><a class=footnote-ref href=#fn:2 rel=footnote>2</a></sup> is a free alternative <a href=https://perfops.net/>PerfOps</a>. I highly recommend this. Their free tier usage (100,000,000 Queries, 3 FlexBalancers) can be good enough. I added answers to various locations according to the result of the App Synthetic Monitor Ping Tool<sup id=fnref:3><a class=footnote-ref href=#fn:3 rel=footnote>3</a></sup>. I have to say, works like a charm.<h3 id=geodns><a class=toclink href=#geodns>GeoDNS</a></h3><p>However CNAME have its shortages:<ol><li>They could be slower than A records.<li>Root CNAME Flattening is <a href=https://archives.snorl.ax/drafts/root-flattening-cname-accuracy-simple-test.html>not that accurate</a>.</ol><p>That's where GeoDNS comes in, with which there's no need in resolving a hostname into an IP, adding an additional request.<p><a href=https://ns1.com/>NS1</a> has a free tier with a limit of 500,000 queries, 50 Records. So it's my go-to solution for load balancing. I'm waiting for DNS propagation to complete. But it's not cost-efficient when overages are billed at $8/million queries.<p><a href=https://aws.amazon.com/route53/pricing/>Route53</a> is cost-efficient and charges for $1.2 a month if the domain uses their GeoDNS and has 1 million DNS queries. So once I have more than 500,000 queries I will switch to this.<p><strong>A Note:</strong> I followed nginxconfig.io<sup id=fnref:8><a class=footnote-ref href=#fn:8 rel=footnote>8</a></sup> to enhance and simplify my nginx config. After doing that, I found TLS speed was slow, the lines of the nginx config from letsencrypt helped and boosted the TLS speed greatly:<div class=highlight><pre><span class=code-line><span></span><span class=nt>ssl_dhparam</span> <span class=o>/</span><span class=nt>etc</span><span class=o>/</span><span class=nt>letsencrypt</span><span class=o>/</span><span class=nt>ssl-dhparams</span><span class=p>.</span><span class=nc>pem</span><span class=o>;</span> <span class=err>#</span> <span class=nt>generated</span> <span class=nt>by</span> <span class=nt>Certbot</span> <span class=nt>when</span> <span class=nt>their</span> <span class=nt>nginx</span> <span class=nt>plugin</span> <span class=nt>is</span> <span class=nt>used</span></span>
<span class=code-line></span>
<span class=code-line><span class=err>#</span> <span class=nt>The</span> <span class=nt>two</span> <span class=nt>lines</span> <span class=nt>below</span> <span class=nt>are</span> <span class=nt>from</span> <span class=nt>their</span> <span class=nt>config</span> <span class=o>/</span><span class=nt>etc</span><span class=o>/</span><span class=nt>letsencrypt</span><span class=o>/</span><span class=nt>options-ssl-nginx</span><span class=p>.</span><span class=nc>conf</span></span>
<span class=code-line><span class=nt>ssl_session_cache</span> <span class=nt>shared</span><span class=p>:</span><span class=nd>le_nginx_SSL</span><span class=p>:</span><span class=nd>50m</span><span class=o>;</span> <span class=err>#</span> <span class=nt>I</span> <span class=nt>modified</span> <span class=nt>the</span> <span class=nt>original</span> <span class=nt>1m</span> <span class=nt>to</span> <span class=nt>50m</span></span>
<span class=code-line><span class=nt>ssl_ciphers</span> <span class=s2>&quot;ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS&quot;</span><span class=o>;</span></span>
</pre></div><div class=footnote><hr><ol><li id=fn:1><p><a href=https://stackoverflow.com/questions/25187817/nginx-reverse-proxy-images-and-css-are-not-loaded/35065881#35065881>nginx reverse proxy images and css are not loaded - Stack Overflow</a>&#160;<a class=footnote-backref href=#fnref:1 rev=footnote title="Jump back to footnote 1 in the text">&#8617;</a><li id=fn:2><p><a href=https://www.reddit.com/r/sysadmin/comments/by6lnh/how_to_make_an_a_record_load_balancer_with_haproxy/eqdiyib/>How to make an A record load balancer with HAProxy? : sysadmin</a>&#160;<a class=footnote-backref href=#fnref:2 rev=footnote title="Jump back to footnote 2 in the text">&#8617;</a><li id=fn:3><p><a href=https://asm.ca.com/en/ping.php>CA App Synthetic Monitor website monitoring service - Ping - IPv6 now supported, give it a shot!</a>&#160;<a class=footnote-backref href=#fnref:3 rev=footnote title="Jump back to footnote 3 in the text">&#8617;</a><li id=fn:4><p><a href=http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#if>conditional within an "if" in Nginx | DigitalOcean</a>&#160;<a class=footnote-backref href=#fnref:4 rev=footnote title="Jump back to footnote 4 in the text">&#8617;</a><li id=fn:5><p><a href=https://stackoverflow.com/questions/18970620/nginx-reject-request-if-header-is-not-present-or-wrong/18972508#18972508>Nginx: Reject request if header is not present or wrong - Stack Overflow</a>&#160;<a class=footnote-backref href=#fnref:5 rev=footnote title="Jump back to footnote 5 in the text">&#8617;</a><li id=fn:6><p><a href=https://www.nginx.com/blog/nginx-caching-guide/>A Guide to Caching with NGINX and NGINX Plus - NGINX</a>&#160;<a class=footnote-backref href=#fnref:6 rev=footnote title="Jump back to footnote 6 in the text">&#8617;</a><li id=fn:7><p><a href=https://forum.nginx.org/read.php?2,234131,234141>Re: nginx add trailing slash</a>&#160;<a class=footnote-backref href=#fnref:7 rev=footnote title="Jump back to footnote 7 in the text">&#8617;</a><li id=fn:8><p><a href=https://nginxconfig.io/>nginxconfig.io</a>&#160;<a class=footnote-backref href=#fnref:8 rev=footnote title="Jump back to footnote 8 in the text">&#8617;</a></ol></div></div><footer id=q><svg id="publish"/><b>Created:&nbsp;</b><time datetime=2019-06-08T22:08:00+02:00>June 08, 2019</time><span id=y>•</span><svg id="edit"/><b>Updated:&nbsp;</b><time datetime=2019-06-18T17:47:00+02:00>June 18, 2019</time><span id=y>•</span><svg id="session"/></svg>In a <a href=https://archives.snorl.ax/terminal/ rel="category tag"><b>Terminal</b></a> Session<span id=y>•</span><svg id="tags"/><b>Tags:&nbsp;</b><a href=https://archives.snorl.ax/tags/nginx/ rel=tag>nginx</a>,&nbsp;<a href=https://archives.snorl.ax/tags/load-balancing/ rel=tag>load balancing</a>,&nbsp;<a href=https://archives.snorl.ax/tags/perfops/ rel=tag>PerfOps</a>,&nbsp;<a href=https://archives.snorl.ax/tags/cloudflare/ rel=tag>cloudflare</a></footer></article><article id=m><div id=n><section id=comments data-title="Doing site mirroring with nginx on the same domain" data-isso-id=/drafts/doing-site-mirroring-with-nginx-on-the-same-domain.html></section></div></article></main></div><footer id=g><div id=l>Simputer Archives &#169; 2016 - 2019 (<a href=https://snorl.ax/>Click to view Current Version of Simputer</a>) • Licensed under <a target=_blank rel=license href=http://creativecommons.org/licenses/by/3.0/>CC BY 3.0</a><br>Made using <a href=http://getpelican.com/ target=_blank>Pelican</a> • Design from <a href=https://wordpress.org/themes/twentyfifteen/ target=_blank>TwentyFifteen</a></div></footer><script data-isso=https://isso.snorl.ax/ data-isso-gravatar=true data-isso-avatar=false data-isso-reply-notifications=true data-isso-reply-to-self=true data-isso-css=false src=https://archives.snorl.ax/theme/js/isso_embed.min.js data-isso-lang=en></script>