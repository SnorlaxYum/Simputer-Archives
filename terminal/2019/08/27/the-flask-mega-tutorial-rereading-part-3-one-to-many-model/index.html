<!doctype html><html lang=en><title>The Flask Mega-Tutorial Rereading - Part 3 - One-To-Many Model - Terminal In A Simputer Archives</title><meta charset=utf-8><link rel=canonical href=https://archives.snorl.ax/terminal/2019/08/27/the-flask-mega-tutorial-rereading-part-3-one-to-many-model/><link href=https://archives.snorl.ax/theme/css/all.css rel=stylesheet><link rel=dns-prefetch href=https://fonts.googleapis.com><link rel=dns-prefetch href=https://fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Luckiest+Guy|Rajdhani:600|Rajdhani:700&amp;display=swap"><link href=https://archives.snorl.ax/theme/images/icon.png rel=icon><link href=https://archives.snorl.ax/theme/images/icon-apple.png rel=apple-touch-icon-precomposed><link href=https://archives.snorl.ax/feeds/terminal.xml rel=alternate title="Simputer Archives Terminal RSS Feed" type=application/rss+xml><meta content=python name=tags><meta content=flask name=tags><meta content=learning notes name=tags><meta content="width=device-width" name=viewport><meta name=twitter:card content=summary><meta name=twitter:image content=https://archives.snorl.ax/theme/images/usual-twitter.png><meta name=twitter:site content=@Snorl_ax><meta name=twitter:title content="The Flask Mega-Tutorial Rereading - Part 3 - One-To-Many Model"><meta name=twitter:description content="Part 3 of the re-reading."><div id=a><header id=c><div id=d><h1 id=e><a href=https://archives.snorl.ax/>Simputer Archives</a></h1></div></header><div id=f><nav id=h><ul><li><a href=https://archives.snorl.ax/>Home</a><li><a href=https://archives.snorl.ax/browser/>Browser</a><li id=i><a href=https://archives.snorl.ax/terminal/>Terminal</a><li><a href=https://archives.snorl.ax/tags/>Tags</a></ul></nav><nav id=r><a href=https://www.youtube.com/channel/UCnqOLMtPJaqa7e_6FhZ8-rw title=Youtube><svg id="youtube"/></a><a href=https://github.com/SnorlaxYum/ title=Github><svg id="github"/></a><a href=https://twitter.com/Snorl_ax title=Twitter><svg id="twitter"/></a><a href=https://archives.snorl.ax/feeds/terminal.xml title="Terminal RSS"><svg id="rss"/></a><a href=mailto:sim@snorl.ax title=Email><svg id="mail"/></a></nav><aside id=j><form action=https://archives.snorl.ax/search.html onsubmit="return validateForm(this.elements['q'].value);"><input placeholder=Search... name=q id=tipue_search_input></form></aside></div></div><div id=b><main id=k><article id=m><header id=o><h2 id=p>The Flask Mega-Tutorial Rereading - Part 3 - One-To-Many Model</h2></header><div id=n><div id=series><p>This post is part 3 of the "The Flask Mega Tutorial" series:<ol class=parts><li><a href=https://archives.snorl.ax/terminal/2019/05/31/running-through-the-flask-mega-tutorial-again/>Running through The Flask Mega-Tutorial Again</a><li><a href=https://archives.snorl.ax/terminal/2019/06/19/the-flask-mega-tutorial-rereading-part-2/>The Flask Mega-Tutorial Rereading - Part 2</a><li id=i><a>The Flask Mega-Tutorial Rereading - Part 3 - One-To-Many Model</a></ol></div><h2 id=toc>Table Of Contents</h2><div class=toc><ul><li><a href=#chapter-7-the-followers>Chapter 7: The Followers</a><ul><li><a href=#add-model>Add Model</a><li><a href=#adding-and-removing-follows>Adding And Removing Follows</a><li><a href=#obtaining-the-posts-from-followed-users>Obtaining the Posts from Followed Users</a><li><a href=#combining-own-and-followed-posts>Combining Own and Followed Posts</a><li><a href=#unit-testing-the-user-model>Unit Testing the User Model</a><li><a href=#integrating-followers-with-the-application>Integrating Followers with the Application</a></ul></ul></div><p>This tutorial<sup id=fnref:1><a class=footnote-ref href=#fn:1 rel=footnote>1</a></sup> is really amazing and worth my second learning.<h2 id=chapter-7-the-followers><a class=toclink href=#chapter-7-the-followers>Chapter 7: The Followers</a></h2><p>Followers is one example of One-to-many model.<h3 id=add-model><a class=toclink href=#add-model>Add Model</a></h3><p>Add <code>followers</code> association table to the database:<p><code>app/models.py</code>:<div class=highlight><pre><span class=code-line><span></span><span class=n>followers</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>Table</span><span class=p>(</span><span class=s1>&#39;followers&#39;</span><span class=p>,</span></span>
<span class=code-line>    <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=s1>&#39;follower_id&#39;</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>Integer</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;user.id&#39;</span><span class=p>)),</span></span>
<span class=code-line>    <span class=n>db</span><span class=o>.</span><span class=n>Column</span><span class=p>(</span><span class=s1>&#39;followed_id&#39;</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>Integer</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>ForeignKey</span><span class=p>(</span><span class=s1>&#39;user.id&#39;</span><span class=p>))</span></span>
<span class=code-line><span class=p>)</span></span>
</pre></div><p>Declare the many-to-many relationship in the users table:<p><code>app/models.py</code>:<div class=highlight><pre><span class=code-line><span></span><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>UserMixin</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span></span>
<span class=code-line>    <span class=c1># ...</span></span>
<span class=code-line>    <span class=n>followed</span> <span class=o>=</span> <span class=n>db</span><span class=o>.</span><span class=n>relationship</span><span class=p>(</span></span>
<span class=code-line>        <span class=s1>&#39;User&#39;</span><span class=p>,</span> <span class=n>secondary</span><span class=o>=</span><span class=n>followers</span><span class=p>,</span></span>
<span class=code-line>        <span class=n>primaryjoin</span><span class=o>=</span><span class=p>(</span><span class=n>followers</span><span class=o>.</span><span class=n>c</span><span class=o>.</span><span class=n>follower_id</span> <span class=o>==</span> <span class=nb>id</span><span class=p>),</span></span>
<span class=code-line>        <span class=n>secondaryjoin</span><span class=o>=</span><span class=p>(</span><span class=n>followers</span><span class=o>.</span><span class=n>c</span><span class=o>.</span><span class=n>followed_id</span> <span class=o>==</span> <span class=nb>id</span><span class=p>),</span></span>
<span class=code-line>        <span class=n>backref</span><span class=o>=</span><span class=n>db</span><span class=o>.</span><span class=n>backref</span><span class=p>(</span><span class=s1>&#39;followers&#39;</span><span class=p>,</span> <span class=n>lazy</span><span class=o>=</span><span class=s1>&#39;dynamic&#39;</span><span class=p>),</span> <span class=n>lazy</span><span class=o>=</span><span class=s1>&#39;dynamic&#39;</span><span class=p>)</span></span>
</pre></div><ul><li><code>'User'</code> is the right side entity of the relationship (the left side entity is the parent class). Since this is a self-referential relationship, the same class is used on both sides.<li><code>secondary</code> configures the association table that is used for this relationship, which I defined right above this class.<li><code>primaryjoin</code> indicates the condition that links the left side entity (the follower user) with the association table. The join condition for the left side of the relationship is the user ID matching the <code>follower_id</code> field of the association table. The <code>followers.c.follower_id</code> expression references the <code>follower_id</code> column of the association table.<li><code>secondaryjoin</code> indicates the condition that links the right side entity (the followed user) with the association table. This condition is similar to the one for primaryjoin, with the only difference that now I'm using <code>followed_id</code>, which is the other foreign key in the association table.<li><code>backref</code> defines how this relationship will be accessed from the right side entity. From the left side, the relationship is named followed, so from the right side I am going to use the name followers to represent all the left side users that are linked to the target user in the right side. The additional lazy argument indicates the execution mode for this query. A mode of dynamic sets up the query to not run until specifically requested, which is also how I set up the posts one-to-many relationship.<li><code>lazy</code> is similar to the parameter of the same name in the backref, but this one applies to the left side query instead of the right side.</ul><p>Record the changes:<div class=highlight><pre><span class=code-line><span></span>(venv)$ flask db migrate -m &quot;followers&quot;</span>
<span class=code-line>(venv)$ flask db upgrade</span>
</pre></div><h3 id=adding-and-removing-follows><a class=toclink href=#adding-and-removing-follows>Adding And Removing Follows</a></h3><p>Follow:<div class=highlight><pre><span class=code-line><span></span><span class=n>user1</span><span class=o>.</span><span class=n>followed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>user2</span><span class=p>)</span></span>
</pre></div><p>Unfollow:<div class=highlight><pre><span class=code-line><span></span><span class=n>user1</span><span class=o>.</span><span class=n>followed</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>user2</span><span class=p>)</span></span>
</pre></div><p><code>app/models.py</code>:<div class=highlight><pre><span class=code-line><span></span><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>UserMixin</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span></span>
<span class=code-line>    <span class=c1>#...</span></span>
<span class=code-line></span>
<span class=code-line>    <span class=k>def</span> <span class=nf>follow</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user</span><span class=p>):</span></span>
<span class=code-line>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_following</span><span class=p>(</span><span class=n>user</span><span class=p>):</span></span>
<span class=code-line>            <span class=bp>self</span><span class=o>.</span><span class=n>followed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>user</span><span class=p>)</span></span>
<span class=code-line></span>
<span class=code-line>    <span class=k>def</span> <span class=nf>unfollow</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user</span><span class=p>):</span></span>
<span class=code-line>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_following</span><span class=p>(</span><span class=n>user</span><span class=p>):</span></span>
<span class=code-line>            <span class=bp>self</span><span class=o>.</span><span class=n>followed</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>user</span><span class=p>)</span></span>
<span class=code-line></span>
<span class=code-line>    <span class=k>def</span> <span class=nf>is_following</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user</span><span class=p>):</span></span>
<span class=code-line>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>followed</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span></span>
<span class=code-line>            <span class=n>followers</span><span class=o>.</span><span class=n>c</span><span class=o>.</span><span class=n>followed_id</span> <span class=o>==</span> <span class=n>user</span><span class=o>.</span><span class=n>id</span><span class=p>)</span><span class=o>.</span><span class=n>count</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span></span>
</pre></div><h3 id=obtaining-the-posts-from-followed-users><a class=toclink href=#obtaining-the-posts-from-followed-users>Obtaining the Posts from Followed Users</a></h3><p><code>app/models.py</code>:<div class=highlight><pre><span class=code-line><span></span><span class=k>class</span> <span class=nc>User</span><span class=p>(</span><span class=n>UserMixin</span><span class=p>,</span> <span class=n>db</span><span class=o>.</span><span class=n>Model</span><span class=p>):</span></span>
<span class=code-line>    <span class=c1>#...</span></span>
<span class=code-line>    <span class=k>def</span> <span class=nf>followed_posts</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span></span>
<span class=code-line>        <span class=k>return</span> <span class=n>Post</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>join</span><span class=p>(</span></span>
<span class=code-line>            <span class=n>followers</span><span class=p>,</span> <span class=p>(</span><span class=n>followers</span><span class=o>.</span><span class=n>c</span><span class=o>.</span><span class=n>followed_id</span> <span class=o>==</span> <span class=n>Post</span><span class=o>.</span><span class=n>user_id</span><span class=p>))</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span></span>
<span class=code-line>                <span class=n>followers</span><span class=o>.</span><span class=n>c</span><span class=o>.</span><span class=n>follower_id</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>id</span><span class=p>)</span><span class=o>.</span><span class=n>order_by</span><span class=p>(</span></span>
<span class=code-line>                    <span class=n>Post</span><span class=o>.</span><span class=n>timestamp</span><span class=o>.</span><span class=n>desc</span><span class=p>())</span></span>
</pre></div><p>The struc of it:<div class=highlight><pre><span class=code-line><span></span><span class=n>Post</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=o>...</span><span class=p>)</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span><span class=o>...</span><span class=p>)</span><span class=o>.</span><span class=n>order_by</span><span class=p>(</span><span class=o>...</span><span class=p>)</span></span>
</pre></div><h3 id=combining-own-and-followed-posts><a class=toclink href=#combining-own-and-followed-posts>Combining Own and Followed Posts</a></h3><p><code>app/models.py</code>:<div class=highlight><pre><span class=code-line><span></span><span class=k>def</span> <span class=nf>followed_posts</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span></span>
<span class=code-line>    <span class=n>followed</span> <span class=o>=</span> <span class=n>Post</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>join</span><span class=p>(</span></span>
<span class=code-line>        <span class=n>followers</span><span class=p>,</span> <span class=p>(</span><span class=n>followers</span><span class=o>.</span><span class=n>c</span><span class=o>.</span><span class=n>followed_id</span> <span class=o>==</span> <span class=n>Post</span><span class=o>.</span><span class=n>user_id</span><span class=p>))</span><span class=o>.</span><span class=n>filter</span><span class=p>(</span></span>
<span class=code-line>            <span class=n>followers</span><span class=o>.</span><span class=n>c</span><span class=o>.</span><span class=n>follower_id</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>id</span><span class=p>)</span></span>
<span class=code-line>    <span class=n>own</span> <span class=o>=</span> <span class=n>Post</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=n>user_id</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>id</span><span class=p>)</span></span>
<span class=code-line>    <span class=k>return</span> <span class=n>followed</span><span class=o>.</span><span class=n>union</span><span class=p>(</span><span class=n>own</span><span class=p>)</span><span class=o>.</span><span class=n>order_by</span><span class=p>(</span><span class=n>Post</span><span class=o>.</span><span class=n>timestamp</span><span class=o>.</span><span class=n>desc</span><span class=p>())</span></span>
</pre></div><h3 id=unit-testing-the-user-model><a class=toclink href=#unit-testing-the-user-model>Unit Testing the User Model</a></h3><p><code>tests.py</code>:<div class=highlight><pre><span class=code-line><span></span><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timedelta</span></span>
<span class=code-line><span class=kn>import</span> <span class=nn>unittest</span></span>
<span class=code-line><span class=kn>from</span> <span class=nn>app</span> <span class=kn>import</span> <span class=n>app</span><span class=p>,</span> <span class=n>db</span></span>
<span class=code-line><span class=kn>from</span> <span class=nn>app.models</span> <span class=kn>import</span> <span class=n>User</span><span class=p>,</span> <span class=n>Post</span></span>
<span class=code-line></span>
<span class=code-line><span class=k>class</span> <span class=nc>UserModelCase</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span></span>
<span class=code-line>    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span></span>
<span class=code-line>        <span class=n>app</span><span class=o>.</span><span class=n>config</span><span class=p>[</span><span class=s1>&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;sqlite://&#39;</span></span>
<span class=code-line>        <span class=n>db</span><span class=o>.</span><span class=n>create_all</span><span class=p>()</span></span>
<span class=code-line></span>
<span class=code-line>    <span class=k>def</span> <span class=nf>tearDown</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span></span>
<span class=code-line>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>remove</span><span class=p>()</span></span>
<span class=code-line>        <span class=n>db</span><span class=o>.</span><span class=n>drop_all</span><span class=p>()</span></span>
<span class=code-line></span>
<span class=code-line>    <span class=k>def</span> <span class=nf>test_password_hashing</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span></span>
<span class=code-line>        <span class=n>u</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;susan&#39;</span><span class=p>)</span></span>
<span class=code-line>        <span class=n>u</span><span class=o>.</span><span class=n>set_password</span><span class=p>(</span><span class=s1>&#39;cat&#39;</span><span class=p>)</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertFalse</span><span class=p>(</span><span class=n>u</span><span class=o>.</span><span class=n>check_password</span><span class=p>(</span><span class=s1>&#39;dog&#39;</span><span class=p>))</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertTrue</span><span class=p>(</span><span class=n>u</span><span class=o>.</span><span class=n>check_password</span><span class=p>(</span><span class=s1>&#39;cat&#39;</span><span class=p>))</span></span>
<span class=code-line></span>
<span class=code-line>    <span class=k>def</span> <span class=nf>test_avatar</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span></span>
<span class=code-line>        <span class=n>u</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;john&#39;</span><span class=p>,</span> <span class=n>email</span><span class=o>=</span><span class=s1>&#39;john@example.com&#39;</span><span class=p>)</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>u</span><span class=o>.</span><span class=n>avatar</span><span class=p>(</span><span class=mi>128</span><span class=p>),</span> <span class=p>(</span><span class=s1>&#39;https://www.gravatar.com/avatar/&#39;</span></span>
<span class=code-line>                                         <span class=s1>&#39;d4c74594d841139328695756648b6bd6&#39;</span></span>
<span class=code-line>                                         <span class=s1>&#39;?d=identicon&amp;s=128&#39;</span><span class=p>))</span></span>
<span class=code-line></span>
<span class=code-line>    <span class=k>def</span> <span class=nf>test_follow</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span></span>
<span class=code-line>        <span class=n>u1</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;john&#39;</span><span class=p>,</span> <span class=n>email</span><span class=o>=</span><span class=s1>&#39;john@example.com&#39;</span><span class=p>)</span></span>
<span class=code-line>        <span class=n>u2</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;susan&#39;</span><span class=p>,</span> <span class=n>email</span><span class=o>=</span><span class=s1>&#39;susan@example.com&#39;</span><span class=p>)</span></span>
<span class=code-line>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>u1</span><span class=p>)</span></span>
<span class=code-line>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>u2</span><span class=p>)</span></span>
<span class=code-line>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>u1</span><span class=o>.</span><span class=n>followed</span><span class=o>.</span><span class=n>all</span><span class=p>(),</span> <span class=p>[])</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>u1</span><span class=o>.</span><span class=n>followers</span><span class=o>.</span><span class=n>all</span><span class=p>(),</span> <span class=p>[])</span></span>
<span class=code-line></span>
<span class=code-line>        <span class=n>u1</span><span class=o>.</span><span class=n>follow</span><span class=p>(</span><span class=n>u2</span><span class=p>)</span></span>
<span class=code-line>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertTrue</span><span class=p>(</span><span class=n>u1</span><span class=o>.</span><span class=n>is_following</span><span class=p>(</span><span class=n>u2</span><span class=p>))</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>u1</span><span class=o>.</span><span class=n>followed</span><span class=o>.</span><span class=n>count</span><span class=p>(),</span> <span class=mi>1</span><span class=p>)</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>u1</span><span class=o>.</span><span class=n>followed</span><span class=o>.</span><span class=n>first</span><span class=p>()</span><span class=o>.</span><span class=n>username</span><span class=p>,</span> <span class=s1>&#39;susan&#39;</span><span class=p>)</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>u2</span><span class=o>.</span><span class=n>followers</span><span class=o>.</span><span class=n>count</span><span class=p>(),</span> <span class=mi>1</span><span class=p>)</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>u2</span><span class=o>.</span><span class=n>followers</span><span class=o>.</span><span class=n>first</span><span class=p>()</span><span class=o>.</span><span class=n>username</span><span class=p>,</span> <span class=s1>&#39;john&#39;</span><span class=p>)</span></span>
<span class=code-line></span>
<span class=code-line>        <span class=n>u1</span><span class=o>.</span><span class=n>unfollow</span><span class=p>(</span><span class=n>u2</span><span class=p>)</span></span>
<span class=code-line>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertFalse</span><span class=p>(</span><span class=n>u1</span><span class=o>.</span><span class=n>is_following</span><span class=p>(</span><span class=n>u2</span><span class=p>))</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>u1</span><span class=o>.</span><span class=n>followed</span><span class=o>.</span><span class=n>count</span><span class=p>(),</span> <span class=mi>0</span><span class=p>)</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>u2</span><span class=o>.</span><span class=n>followers</span><span class=o>.</span><span class=n>count</span><span class=p>(),</span> <span class=mi>0</span><span class=p>)</span></span>
<span class=code-line></span>
<span class=code-line>    <span class=k>def</span> <span class=nf>test_follow_posts</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span></span>
<span class=code-line>        <span class=c1># create four users</span></span>
<span class=code-line>        <span class=n>u1</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;john&#39;</span><span class=p>,</span> <span class=n>email</span><span class=o>=</span><span class=s1>&#39;john@example.com&#39;</span><span class=p>)</span></span>
<span class=code-line>        <span class=n>u2</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;susan&#39;</span><span class=p>,</span> <span class=n>email</span><span class=o>=</span><span class=s1>&#39;susan@example.com&#39;</span><span class=p>)</span></span>
<span class=code-line>        <span class=n>u3</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;mary&#39;</span><span class=p>,</span> <span class=n>email</span><span class=o>=</span><span class=s1>&#39;mary@example.com&#39;</span><span class=p>)</span></span>
<span class=code-line>        <span class=n>u4</span> <span class=o>=</span> <span class=n>User</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=s1>&#39;david&#39;</span><span class=p>,</span> <span class=n>email</span><span class=o>=</span><span class=s1>&#39;david@example.com&#39;</span><span class=p>)</span></span>
<span class=code-line>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add_all</span><span class=p>([</span><span class=n>u1</span><span class=p>,</span> <span class=n>u2</span><span class=p>,</span> <span class=n>u3</span><span class=p>,</span> <span class=n>u4</span><span class=p>])</span></span>
<span class=code-line></span>
<span class=code-line>        <span class=c1># create four posts</span></span>
<span class=code-line>        <span class=n>now</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>utcnow</span><span class=p>()</span></span>
<span class=code-line>        <span class=n>p1</span> <span class=o>=</span> <span class=n>Post</span><span class=p>(</span><span class=n>body</span><span class=o>=</span><span class=s2>&quot;post from john&quot;</span><span class=p>,</span> <span class=n>author</span><span class=o>=</span><span class=n>u1</span><span class=p>,</span></span>
<span class=code-line>                  <span class=n>timestamp</span><span class=o>=</span><span class=n>now</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>seconds</span><span class=o>=</span><span class=mi>1</span><span class=p>))</span></span>
<span class=code-line>        <span class=n>p2</span> <span class=o>=</span> <span class=n>Post</span><span class=p>(</span><span class=n>body</span><span class=o>=</span><span class=s2>&quot;post from susan&quot;</span><span class=p>,</span> <span class=n>author</span><span class=o>=</span><span class=n>u2</span><span class=p>,</span></span>
<span class=code-line>                  <span class=n>timestamp</span><span class=o>=</span><span class=n>now</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>seconds</span><span class=o>=</span><span class=mi>4</span><span class=p>))</span></span>
<span class=code-line>        <span class=n>p3</span> <span class=o>=</span> <span class=n>Post</span><span class=p>(</span><span class=n>body</span><span class=o>=</span><span class=s2>&quot;post from mary&quot;</span><span class=p>,</span> <span class=n>author</span><span class=o>=</span><span class=n>u3</span><span class=p>,</span></span>
<span class=code-line>                  <span class=n>timestamp</span><span class=o>=</span><span class=n>now</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>seconds</span><span class=o>=</span><span class=mi>3</span><span class=p>))</span></span>
<span class=code-line>        <span class=n>p4</span> <span class=o>=</span> <span class=n>Post</span><span class=p>(</span><span class=n>body</span><span class=o>=</span><span class=s2>&quot;post from david&quot;</span><span class=p>,</span> <span class=n>author</span><span class=o>=</span><span class=n>u4</span><span class=p>,</span></span>
<span class=code-line>                  <span class=n>timestamp</span><span class=o>=</span><span class=n>now</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>seconds</span><span class=o>=</span><span class=mi>2</span><span class=p>))</span></span>
<span class=code-line>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>add_all</span><span class=p>([</span><span class=n>p1</span><span class=p>,</span> <span class=n>p2</span><span class=p>,</span> <span class=n>p3</span><span class=p>,</span> <span class=n>p4</span><span class=p>])</span></span>
<span class=code-line>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span></span>
<span class=code-line></span>
<span class=code-line>        <span class=c1># setup the followers</span></span>
<span class=code-line>        <span class=n>u1</span><span class=o>.</span><span class=n>follow</span><span class=p>(</span><span class=n>u2</span><span class=p>)</span>  <span class=c1># john follows susan</span></span>
<span class=code-line>        <span class=n>u1</span><span class=o>.</span><span class=n>follow</span><span class=p>(</span><span class=n>u4</span><span class=p>)</span>  <span class=c1># john follows david</span></span>
<span class=code-line>        <span class=n>u2</span><span class=o>.</span><span class=n>follow</span><span class=p>(</span><span class=n>u3</span><span class=p>)</span>  <span class=c1># susan follows mary</span></span>
<span class=code-line>        <span class=n>u3</span><span class=o>.</span><span class=n>follow</span><span class=p>(</span><span class=n>u4</span><span class=p>)</span>  <span class=c1># mary follows david</span></span>
<span class=code-line>        <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span></span>
<span class=code-line></span>
<span class=code-line>        <span class=c1># check the followed posts of each user</span></span>
<span class=code-line>        <span class=n>f1</span> <span class=o>=</span> <span class=n>u1</span><span class=o>.</span><span class=n>followed_posts</span><span class=p>()</span><span class=o>.</span><span class=n>all</span><span class=p>()</span></span>
<span class=code-line>        <span class=n>f2</span> <span class=o>=</span> <span class=n>u2</span><span class=o>.</span><span class=n>followed_posts</span><span class=p>()</span><span class=o>.</span><span class=n>all</span><span class=p>()</span></span>
<span class=code-line>        <span class=n>f3</span> <span class=o>=</span> <span class=n>u3</span><span class=o>.</span><span class=n>followed_posts</span><span class=p>()</span><span class=o>.</span><span class=n>all</span><span class=p>()</span></span>
<span class=code-line>        <span class=n>f4</span> <span class=o>=</span> <span class=n>u4</span><span class=o>.</span><span class=n>followed_posts</span><span class=p>()</span><span class=o>.</span><span class=n>all</span><span class=p>()</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>f1</span><span class=p>,</span> <span class=p>[</span><span class=n>p2</span><span class=p>,</span> <span class=n>p4</span><span class=p>,</span> <span class=n>p1</span><span class=p>])</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>f2</span><span class=p>,</span> <span class=p>[</span><span class=n>p2</span><span class=p>,</span> <span class=n>p3</span><span class=p>])</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>f3</span><span class=p>,</span> <span class=p>[</span><span class=n>p3</span><span class=p>,</span> <span class=n>p4</span><span class=p>])</span></span>
<span class=code-line>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>f4</span><span class=p>,</span> <span class=p>[</span><span class=n>p4</span><span class=p>])</span></span>
<span class=code-line></span>
<span class=code-line><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span></span>
<span class=code-line>    <span class=n>unittest</span><span class=o>.</span><span class=n>main</span><span class=p>(</span><span class=n>verbosity</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span></span>
</pre></div><h3 id=integrating-followers-with-the-application><a class=toclink href=#integrating-followers-with-the-application>Integrating Followers with the Application</a></h3><p><code>app/routes.py</code>:<div class=highlight><pre><span class=code-line><span></span><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/follow/&lt;username&gt;&#39;</span><span class=p>)</span></span>
<span class=code-line><span class=nd>@login_required</span></span>
<span class=code-line><span class=k>def</span> <span class=nf>follow</span><span class=p>(</span><span class=n>username</span><span class=p>):</span></span>
<span class=code-line>    <span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span></span>
<span class=code-line>    <span class=k>if</span> <span class=n>user</span> <span class=ow>is</span> <span class=bp>None</span><span class=p>:</span></span>
<span class=code-line>        <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;User {} not found.&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>username</span><span class=p>))</span></span>
<span class=code-line>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>))</span></span>
<span class=code-line>    <span class=k>if</span> <span class=n>user</span> <span class=o>==</span> <span class=n>current_user</span><span class=p>:</span></span>
<span class=code-line>        <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;You cannot follow yourself!&#39;</span><span class=p>)</span></span>
<span class=code-line>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>))</span></span>
<span class=code-line>    <span class=n>current_user</span><span class=o>.</span><span class=n>follow</span><span class=p>(</span><span class=n>user</span><span class=p>)</span></span>
<span class=code-line>    <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span></span>
<span class=code-line>    <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;You are following {}!&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>username</span><span class=p>))</span></span>
<span class=code-line>    <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>))</span></span>
<span class=code-line></span>
<span class=code-line><span class=nd>@app.route</span><span class=p>(</span><span class=s1>&#39;/unfollow/&lt;username&gt;&#39;</span><span class=p>)</span></span>
<span class=code-line><span class=nd>@login_required</span></span>
<span class=code-line><span class=k>def</span> <span class=nf>unfollow</span><span class=p>(</span><span class=n>username</span><span class=p>):</span></span>
<span class=code-line>    <span class=n>user</span> <span class=o>=</span> <span class=n>User</span><span class=o>.</span><span class=n>query</span><span class=o>.</span><span class=n>filter_by</span><span class=p>(</span><span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span></span>
<span class=code-line>    <span class=k>if</span> <span class=n>user</span> <span class=ow>is</span> <span class=bp>None</span><span class=p>:</span></span>
<span class=code-line>        <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;User {} not found.&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>username</span><span class=p>))</span></span>
<span class=code-line>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>))</span></span>
<span class=code-line>    <span class=k>if</span> <span class=n>user</span> <span class=o>==</span> <span class=n>current_user</span><span class=p>:</span></span>
<span class=code-line>        <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;You cannot unfollow yourself!&#39;</span><span class=p>)</span></span>
<span class=code-line>        <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>))</span></span>
<span class=code-line>    <span class=n>current_user</span><span class=o>.</span><span class=n>unfollow</span><span class=p>(</span><span class=n>user</span><span class=p>)</span></span>
<span class=code-line>    <span class=n>db</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span></span>
<span class=code-line>    <span class=n>flash</span><span class=p>(</span><span class=s1>&#39;You are not following {}.&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>username</span><span class=p>))</span></span>
<span class=code-line>    <span class=k>return</span> <span class=n>redirect</span><span class=p>(</span><span class=n>url_for</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>))</span></span>
</pre></div><p><code>app/templates/user.html</code>:<div class=highlight><pre><span class=code-line><span></span>...</span>
<span class=code-line><span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>User: {{ user.username }}<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span></span>
<span class=code-line>{% if user.about_me %}<span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>{{ user.about_me }}<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>{% endif %}</span>
<span class=code-line>{% if user.last_seen %}<span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>Last seen on: {{ user.last_seen }}<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>{% endif %}</span>
<span class=code-line><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;</span>{{ user.followers.count() }} followers, {{ user.followed.count() }} following.<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span></span>
<span class=code-line>{% if user == current_user %}</span>
<span class=code-line><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;{{ url_for(&#39;edit_profile&#39;) }}&quot;</span><span class=p>&gt;</span>Edit your profile<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span></span>
<span class=code-line>{% elif not current_user.is_following(user) %}</span>
<span class=code-line><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;{{ url_for(&#39;follow&#39;, username=user.username) }}&quot;</span><span class=p>&gt;</span>Follow<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span></span>
<span class=code-line>{% else %}</span>
<span class=code-line><span class=p>&lt;</span><span class=nt>p</span><span class=p>&gt;&lt;</span><span class=nt>a</span> <span class=na>href</span><span class=o>=</span><span class=s>&quot;{{ url_for(&#39;unfollow&#39;, username=user.username) }}&quot;</span><span class=p>&gt;</span>Unfollow<span class=p>&lt;/</span><span class=nt>a</span><span class=p>&gt;&lt;/</span><span class=nt>p</span><span class=p>&gt;</span></span>
<span class=code-line>{% endif %}</span>
<span class=code-line>...</span>
</pre></div><div class=footnote><hr><ol><li id=fn:1><p><a href=https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-viii-followers>The Flask Mega-Tutorial Part VIII: Followers - miguelgrinberg.com</a>&#160;<a class=footnote-backref href=#fnref:1 rev=footnote title="Jump back to footnote 1 in the text">&#8617;</a></ol></div></div><footer id=q><svg id="publish"/><b>Created:&nbsp;</b><time datetime=2019-08-27T22:16:00+02:00>August 27, 2019</time><span id=y>•</span><svg id="session"/></svg>In a <a href=https://archives.snorl.ax/terminal/ rel="category tag"><b>Terminal</b></a> Session<span id=y>•</span><svg id="tags"/><b>Tags:&nbsp;</b><a href=https://archives.snorl.ax/tags/python/ rel=tag>python</a>,&nbsp;<a href=https://archives.snorl.ax/tags/flask/ rel=tag>flask</a>,&nbsp;<a href=https://archives.snorl.ax/tags/learning-notes/ rel=tag>learning notes</a></footer></article><article id=m><div id=n><section id=comments data-title="The Flask Mega-Tutorial Rereading - Part 3 - One-To-Many Model" data-isso-id=/terminal/2019/08/27/the-flask-mega-tutorial-rereading-part-3-one-to-many-model/></section></div></article></main></div><footer id=g><div id=l>Simputer Archives &#169; 2016 - 2019 (<a href=https://snorl.ax/>Click to view Current Version of Simputer</a>) • Licensed under <a target=_blank rel=license href=http://creativecommons.org/licenses/by/3.0/>CC BY 3.0</a><br>Made using <a href=http://getpelican.com/ target=_blank>Pelican</a> • Design from <a href=https://wordpress.org/themes/twentyfifteen/ target=_blank>TwentyFifteen</a></div></footer><script data-isso=https://isso.snorl.ax/ data-isso-gravatar=true data-isso-avatar=false data-isso-reply-notifications=true data-isso-reply-to-self=true data-isso-css=false src=https://archives.snorl.ax/theme/js/isso_embed.min.js data-isso-lang=en></script>