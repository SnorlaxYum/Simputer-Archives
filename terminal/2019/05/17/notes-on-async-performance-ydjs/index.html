<!doctype html><html lang=en><title>Notes on Async & Performance (YDJS) - Terminal In A Simputer Archives</title><meta charset=utf-8><link rel=canonical href=https://archives.snorl.ax/terminal/2019/05/17/notes-on-async-performance-ydjs/><link href=https://archives.snorl.ax/theme/css/all.css rel=stylesheet><link rel=dns-prefetch href=https://fonts.googleapis.com><link rel=dns-prefetch href=https://fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Luckiest+Guy|Rajdhani:600|Rajdhani:700&amp;display=swap"><link href=https://archives.snorl.ax/theme/images/icon.png rel=icon><link href=https://archives.snorl.ax/theme/images/icon-apple.png rel=apple-touch-icon-precomposed><link href=https://archives.snorl.ax/feeds/terminal.xml rel=alternate title="Simputer Archives Terminal RSS Feed" type=application/rss+xml><meta content=js name=tags><meta content=You don't know js name=tags><meta content=learning notes name=tags><meta content="width=device-width" name=viewport><meta name=twitter:card content=summary><meta name=twitter:image content=https://archives.snorl.ax/theme/images/usual-twitter.png><meta name=twitter:site content=@Snorl_ax><meta name=twitter:title content="Notes on Async & Performance (YDJS)"><meta name=twitter:description content="Notes on You Don't Know JS: Async & Performance."><div id=a><header id=c><div id=d><h1 id=e><a href=https://archives.snorl.ax/>Simputer Archives</a></h1></div></header><div id=f><nav id=h><ul><li><a href=https://archives.snorl.ax/>Home</a><li><a href=https://archives.snorl.ax/browser/>Browser</a><li id=i><a href=https://archives.snorl.ax/terminal/>Terminal</a><li><a href=https://archives.snorl.ax/tags/>Tags</a></ul></nav><nav id=r><a href=https://www.youtube.com/channel/UCnqOLMtPJaqa7e_6FhZ8-rw title=Youtube><svg id="youtube"/></a><a href=https://github.com/SnorlaxYum/ title=Github><svg id="github"/></a><a href=https://twitter.com/Snorl_ax title=Twitter><svg id="twitter"/></a><a href=https://archives.snorl.ax/feeds/terminal.xml title="Terminal RSS"><svg id="rss"/></a><a href=mailto:sim@snorl.ax title=Email><svg id="mail"/></a></nav><aside id=j><form action=https://archives.snorl.ax/search.html onsubmit="return validateForm(this.elements['q'].value);"><input placeholder=Search... name=q id=tipue_search_input></form></aside></div></div><div id=b><main id=k><article id=m><header id=o><h2 id=p>Notes on Async & Performance (YDJS)</h2></header><div id=n><div id=series><p>This post is part 2 of the "You Don't Know JS Read Note" series:<ol class=parts><li><a href=https://archives.snorl.ax/terminal/2019/05/07/notes-on-types-grammer-ydjs/>Notes on Types & Grammer (YDJS)</a><li id=i><a>Notes on Async & Performance (YDJS)</a></ol></div><p>Seems I've taken rather complicated note one the last one.<h2 id=toctable>Table Of Contents</h2><div class=toc><ul><li><a href=#chapter-1-asynchrony-now-later>Chapter 1: Asynchrony: Now &amp; Later</a><ul><li><a href=#a-program-in-chunks>A Program in Chunks</a><ul><li><a href=#async-console>Async Console</a></ul><li><a href=#event-loop>Event Loop</a><li><a href=#parallel-threading>Parallel Threading</a><li><a href=#concurrency>Concurrency</a><ul><li><a href=#noninteracting>Noninteracting</a><li><a href=#interaction>Interaction</a><li><a href=#cooperation>Cooperation</a></ul><li><a href=#jobs>Jobs</a><li><a href=#statement-ordering>Statement Ordering</a></ul><li><a href=#chapter-2-callbacks>Chapter 2: Callbacks</a><ul><li><a href=#continuations>Continuations</a><li><a href=#sequential-brain>Sequential Brain</a><ul><li><a href=#doing-versus-planning>Doing Versus Planning</a><li><a href=#nestedchained-callbacks>Nested/Chained Callbacks</a></ul><li><a href=#trust-issues>Trust Issues</a><ul><li><a href=#tale-of-five-callbacks>Tale of Five Callbacks</a><li><a href=#not-just-others-code>Not Just Others' Code</a></ul><li><a href=#trying-to-save-callbacks>Trying to Save Callbacks</a><li><a href=#review>Review</a></ul><li><a href=#chapter-3-promises>Chapter 3: Promises</a></ul></div><h2 id=chapter-1-asynchrony-now-later><a class=toclink href=#chapter-1-asynchrony-now-later>Chapter 1: Asynchrony: Now &amp; Later</a></h2><p>One of the most essential parts in language like ja is about how to express and manipulate program over time. Before getting there, it's helpful to understand much more deeply what asynchrony is and how it operates in JS.<h3 id=a-program-in-chunks><a class=toclink href=#a-program-in-chunks>A Program in Chunks</a></h3><p><em>now</em> chunk: stuff that runs now.<br><em>later</em> chunk: stuff that runs later.<h4 id=async-console><a class=toclink href=#async-console>Async Console</a></h4><p><code>console.log</code> differs between different browsers. Some doesn't output the result immediately.<h3 id=event-loop><a class=toclink href=#event-loop>Event Loop</a></h3><p>It acts as a queue, first-in, first-out.<h3 id=parallel-threading><a class=toclink href=#parallel-threading>Parallel Threading</a></h3><p>In a parallel system, avoid the different actions on the same variable, which might lead to unexpected results (different orders, different results on the same codes).<p><code>race condition</code>: function ordering nondeterminism.<h3 id=concurrency><a class=toclink href=#concurrency>Concurrency</a></h3><p>The single-threaded event loop is one expression of concurrency with sequential results.<h4 id=noninteracting><a class=toclink href=#noninteracting>Noninteracting</a></h4><p>If two concurrent processes act independently, the code will behave right regardless of ordering.<h4 id=interaction><a class=toclink href=#interaction>Interaction</a></h4><p>Do things to coordinate interactions between processes:<ol><li>Push two individuals into the array(<code>arrvar.push(thing)</code>) and make sure the order: determine the order in advance<li>Assign value to var a and var b in different processes and need them both at the same time: make sure <code>a &amp;&amp; b</code> returns true in <code>if</code>.<li>Different call on the same variable <code>a</code> and may cause unexpected result: <code>if (a == undefined)</code></ol><h4 id=cooperation><a class=toclink href=#cooperation>Cooperation</a></h4><p>An Ajax response handler that needs to run through a long list of results to transform the values:<div class=highlight><pre><span class=code-line><span></span><span class=kd>var</span> <span class=nx>res</span> <span class=o>=</span> <span class=p>[];</span></span>
<span class=code-line></span>
<span class=code-line><span class=c1>// `response(..)` receives array of results from the Ajax call</span></span>
<span class=code-line><span class=kd>function</span> <span class=nx>response</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>{</span></span>
<span class=code-line>    <span class=c1>// let&#39;s just do 1000 at a time</span></span>
<span class=code-line>    <span class=kd>var</span> <span class=nx>chunk</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>splice</span><span class=p>(</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1000</span> <span class=p>);</span></span>
<span class=code-line></span>
<span class=code-line>    <span class=c1>// add onto existing `res` array</span></span>
<span class=code-line>    <span class=nx>res</span> <span class=o>=</span> <span class=nx>res</span><span class=p>.</span><span class=nx>concat</span><span class=p>(</span></span>
<span class=code-line>        <span class=c1>// make a new transformed array with all `chunk` values doubled</span></span>
<span class=code-line>        <span class=nx>chunk</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span> <span class=kd>function</span><span class=p>(</span><span class=nx>val</span><span class=p>){</span></span>
<span class=code-line>            <span class=k>return</span> <span class=nx>val</span> <span class=o>*</span> <span class=mi>2</span><span class=p>;</span></span>
<span class=code-line>        <span class=p>}</span> <span class=p>)</span></span>
<span class=code-line>    <span class=p>);</span></span>
<span class=code-line></span>
<span class=code-line>    <span class=c1>// anything left to process?</span></span>
<span class=code-line>    <span class=k>if</span> <span class=p>(</span><span class=nx>data</span><span class=p>.</span><span class=nx>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span></span>
<span class=code-line>        <span class=c1>// async schedule next batch</span></span>
<span class=code-line>        <span class=nx>setTimeout</span><span class=p>(</span> <span class=kd>function</span><span class=p>(){</span></span>
<span class=code-line>            <span class=nx>response</span><span class=p>(</span> <span class=nx>data</span> <span class=p>);</span></span>
<span class=code-line>        <span class=p>},</span> <span class=mi>0</span> <span class=p>);</span></span>
<span class=code-line>    <span class=p>}</span></span>
<span class=code-line><span class=p>}</span></span>
<span class=code-line></span>
<span class=code-line><span class=c1>// ajax(..) is some arbitrary Ajax function given by a library</span></span>
<span class=code-line><span class=nx>ajax</span><span class=p>(</span> <span class=s2>&quot;http://some.url.1&quot;</span><span class=p>,</span> <span class=nx>response</span> <span class=p>);</span></span>
<span class=code-line><span class=nx>ajax</span><span class=p>(</span> <span class=s2>&quot;http://some.url.2&quot;</span><span class=p>,</span> <span class=nx>response</span> <span class=p>);</span></span>
</pre></div><p><code>setTimeout(..0)</code> is not technically inserting an item directly onto the event loop queue. The timer will insert the event at its next opportunity. Not guaranteed to process in call order. There's not a single direct way (at least yet) across all environments to ensure async event ordering. This topic will be covered in more detail in the next section.<h3 id=jobs><a class=toclink href=#jobs>Jobs</a></h3><p><code>Job Queue</code>: New concept in ES6. Make the job implemented <strong>later, but as soon as possible</strong>.<h3 id=statement-ordering><a class=toclink href=#statement-ordering>Statement Ordering</a></h3><p>The order in which we express statements in our code is not necessarily the same order as the JS engine will execute them. That may seem like quite a strange assertion to make.<h2 id=chapter-2-callbacks><a class=toclink href=#chapter-2-callbacks>Chapter 2: Callbacks</a></h2><p><code>callback</code>: the target for the event loop to "call back into" the program, whenever that item in the queue is processed.<p>The callback function is the async work horse for JavaScript, and it does its job respectably. A couple of these is explored in the chapter.<h3 id=continuations><a class=toclink href=#continuations>Continuations</a></h3><p>First half executes immediately, then pause at the callback function to get the response, then continue with the second half.<h3 id=sequential-brain><a class=toclink href=#sequential-brain>Sequential Brain</a></h3><p>JS would probably feel like a sequential brain, switching to various different processes constantly.<h4 id=doing-versus-planning><a class=toclink href=#doing-versus-planning>Doing Versus Planning</a></h4><p>The reason it's so hard to accrately author and reason about async JS code with callbacks: it's not how our brain works.<h4 id=nestedchained-callbacks><a class=toclink href=#nestedchained-callbacks>Nested/Chained Callbacks</a></h4><p><code>callback hells</code>: callback continuations are happening <em>simultaneously</em>.<h3 id=trust-issues><a class=toclink href=#trust-issues>Trust Issues</a></h3><p><code>inversion of control</code>: you take part of your program and give over control of its execution to another third party<h4 id=tale-of-five-callbacks><a class=toclink href=#tale-of-five-callbacks>Tale of Five Callbacks</a></h4><p>Investing an awful lot of ad hoc logic <strong>in every and single callback</strong> leads to <code>callback hell</code>.<h4 id=not-just-others-code><a class=toclink href=#not-just-others-code>Not Just Others' Code</a></h4><p>Necessary to do <em>inversion of control</em>.<h3 id=trying-to-save-callbacks><a class=toclink href=#trying-to-save-callbacks>Trying to Save Callbacks</a></h3><p>trust issues:<ol><li>There's nothing about either callback that prevents or filters unwanted repeated invocations.<li>Being never called<li>Too Early</ol><p>ES6 has arrived on the scene with some great answers to these trust issues.<h3 id=review><a class=toclink href=#review>Review</a></h3><p>We need a generalized solution to <strong>all of the trust issues</strong>, one that can be reused for as many callbacks as we create without all the extra boilerplate overhead.<p>We need something better than callbacks. They've served us well to this point, but the <em>future</em> of JavaScript demands more sophisticated and capable async patterns.<h2 id=chapter-3-promises><a class=toclink href=#chapter-3-promises>Chapter 3: Promises</a></h2><p>To b continued......</div><footer id=q><svg id="publish"/><b>Created:&nbsp;</b><time datetime=2019-05-17T17:00:00+02:00>May 17, 2019</time><span id=y>•</span><svg id="edit"/><b>Updated:&nbsp;</b><time datetime=2019-05-19T22:00:00+02:00>May 19, 2019</time><span id=y>•</span><svg id="session"/></svg>In a <a href=https://archives.snorl.ax/terminal/ rel="category tag"><b>Terminal</b></a> Session<span id=y>•</span><svg id="tags"/><b>Tags:&nbsp;</b><a href=https://archives.snorl.ax/tags/js/ rel=tag>js</a>,&nbsp;<a href=https://archives.snorl.ax/tags/you-dont-know-js/ rel=tag>You don't know Js</a>,&nbsp;<a href=https://archives.snorl.ax/tags/learning-notes/ rel=tag>learning notes</a></footer></article><article id=m><div id=n><section id=comments data-title="Notes on Async & Performance (YDJS)" data-isso-id=/terminal/2019/05/17/notes-on-async-performance-ydjs/></section></div></article></main></div><footer id=g><div id=l>Simputer Archives &#169; 2016 - 2019 (<a href=https://snorl.ax/>Click to view Current Version of Simputer</a>) • Licensed under <a target=_blank rel=license href=http://creativecommons.org/licenses/by/3.0/>CC BY 3.0</a><br>Made using <a href=http://getpelican.com/ target=_blank>Pelican</a> • Design from <a href=https://wordpress.org/themes/twentyfifteen/ target=_blank>TwentyFifteen</a></div></footer><script data-isso=https://isso.snorl.ax/ data-isso-gravatar=true data-isso-avatar=false data-isso-reply-notifications=true data-isso-reply-to-self=true data-isso-css=false src=https://archives.snorl.ax/theme/js/isso_embed.min.js data-isso-lang=en></script>